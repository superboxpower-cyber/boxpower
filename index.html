<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxPower V18.4 - Search Fix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        
        /* Glass & Utils */
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 120px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Scrollbar Neon */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; border: 2px solid #0f172a; }
        ::-webkit-scrollbar-thumb:hover { background-color: #3b82f6; }

        /* Tables */
        .report-container { overflow-x: auto; position: relative; max-width: 100vw; border-radius: 0 0 1rem 1rem; }
        .report-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .report-table th, .report-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); border-right: 1px solid rgba(255,255,255,0.02); white-space: nowrap; }
        .sticky-col { position: sticky; left: 0; z-index: 10; background: #1e293b; border-right: 2px solid rgba(255,255,255,0.1); min-width: 140px; max-width: 140px; text-align: left !important; font-weight: bold; }
        th.sticky-col { z-index: 20; background: #0f172a; }
        .sub-header { font-size: 0.65rem; color: #64748b; font-weight: normal; background: rgba(15, 23, 42, 0.8); }
        .report-table th { font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; }
        .report-table td { font-size: 0.8rem; }

        /* Chat Widget */
        #chat-widget { position: fixed; bottom: 80px; right: 20px; z-index: 50; display: flex; flex-direction: column; align-items: flex-end; pointer-events: none; }
        #chat-widget > * { pointer-events: auto; }
        #chat-window { 
            width: 320px; height: 450px; background: #1e293b; border: 1px solid #334155; 
            border-radius: 20px; display: none; flex-direction: column; overflow: hidden; 
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.5); margin-bottom: 10px;
            animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        #chat-messages { flex: 1; overflow-y: auto; padding: 15px; space-y: 10px; font-size: 0.8rem; scroll-behavior: smooth; }
        
        .msg-user { align-self: flex-end; background: #2563eb; color: white; padding: 10px 14px; border-radius: 12px 12px 0 12px; max-width: 85%; margin-left: auto; margin-bottom: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .msg-bot { align-self: flex-start; background: #334155; color: #e2e8f0; padding: 10px 14px; border-radius: 12px 12px 12px 0; max-width: 90%; margin-right: auto; margin-bottom: 8px; border: 1px solid #475569; box-shadow: 0 2px 4px rgba(0,0,0,0.1); display: flex; flex-direction: column; gap: 6px; }
        .msg-success { border-left: 3px solid #10b981; }
        .msg-error { border-left: 3px solid #ef4444; }

        /* Bot√µes Interativos */
        .chat-options { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 4px; }
        .chat-btn { background: #0f172a; border: 1px solid #475569; color: #cbd5e1; padding: 8px 12px; border-radius: 8px; font-size: 11px; font-weight: 600; cursor: pointer; transition: all 0.2s; display: flex; items-center; gap: 6px; }
        .chat-btn:active { transform: scale(0.95); }
        .chat-btn:hover { background: #334155; border-color: #64748b; color: white; }
        .chat-btn-danger { background: #450a0a; border-color: #ef4444; color: #fca5a5; }
        .chat-btn-success { background: #064e3b; border-color: #10b981; color: #6ee7b7; }
        
        select option { background-color: #0f172a; color: #e2e8f0; }
        
        /* Anima√ß√µes */
        #history-form-container { transition: all 0.3s ease; overflow: hidden; max-height: 0; opacity: 0; }
        #history-form-container.open { max-height: 200px; opacity: 1; margin-bottom: 1rem; }

        /* --- NOTIFICA√á√ïES FLUTUANTES (TOAST) --- */
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .toast-card { background: rgba(6, 78, 59, 0.95); backdrop-filter: blur(8px); border: 1px solid #34d399; color: white; padding: 16px; rounded: 12px; width: 300px; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); pointer-events: auto; animation: slideInRight 0.5s cubic-bezier(0.16, 1, 0.3, 1); display: flex; align-items: center; gap: 12px; }
        .toast-card.fade-out { opacity: 0; transform: translateY(-20px); transition: all 0.5s; }
        @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

        /* CORRE√á√ÉO MOBILE: Centralizar notifica√ß√£o */
        @media (max-width: 640px) {
            #notification-area { right: 0; left: 0; top: 10px; align-items: center; }
            .toast-card { width: 90%; max-width: 350px; }
        }

        /* --- CENTRAL DE NOTIFICA√á√ïES (SINO) --- */
        .notif-btn { position: relative; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 9px; font-weight: bold; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #0f172a; opacity: 0; transition: opacity 0.3s; }
        .notif-badge.visible { opacity: 1; }

        #notif-panel { 
            position: absolute; top: 70px; right: 20px; width: 320px; max-height: 400px; 
            background: #1e293b; border: 1px solid #334155; border-radius: 16px; 
            box-shadow: 0 20px 25px -5px rgba(0,0,0,0.5); z-index: 60; 
            display: none; flex-direction: column; overflow: hidden;
            animation: slideDown 0.2s ease-out;
        }
        @keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

        .notif-header { padding: 12px; background: #0f172a; border-bottom: 1px solid #334155; font-size: 11px; font-weight: bold; color: #94a3b8; display: flex; justify-content: space-between; align-items: center; }
        .notif-list { overflow-y: auto; max-height: 350px; }
        .notif-item { padding: 12px; border-bottom: 1px solid #334155; display: flex; gap: 10px; transition: background 0.2s; }
        .notif-item:hover { background: #334155; }
        .notif-icon { width: 32px; height: 32px; background: rgba(16, 185, 129, 0.2); color: #34d399; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; shrink: 0; }

    </style>
</head>
<body>

    <div id="notification-area"></div>

    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-950 transition-opacity duration-300">
        <div class="glass p-8 rounded-3xl w-80 text-center shadow-2xl border-t border-blue-500/30">
            <div class="flex justify-center mb-6">
                <img src="https://i.ibb.co/6JP034RZ/Whats-App-Image-2026-01-30-at-18-18-51.jpg" 
                     onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" 
                     alt="BoxPower Logo" 
                     class="w-32 h-32 object-contain drop-shadow-2xl rounded-2xl">
            </div>
            <h1 class="text-2xl font-bold mb-2 text-white">BoxPower</h1>
            <p class="text-slate-400 text-sm mb-6">Acesso Administrativo</p>
            <input type="password" id="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" 
                class="w-full bg-slate-800 border border-slate-700 rounded-xl py-4 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500 transition-all mb-4 text-white">
            <button id="btn-login" onclick="performLogin()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg">ENTRAR</button>
        </div>
    </div>

    <div id="main-content" class="hidden opacity-0 transition-opacity duration-500 flex flex-col h-full">
        
        <header class="p-6 flex justify-between items-center bg-slate-900/90 sticky top-0 z-20 backdrop-blur-sm border-b border-slate-800 shrink-0">
            <div>
                <h2 class="text-slate-400 text-[10px] font-bold uppercase tracking-widest mb-1">Gest√£o Financeira</h2>
                <div class="flex items-baseline gap-2">
                    <h1 class="text-3xl sm:text-4xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-white drop-shadow-lg">BoxPower</h1>
                    <span class="text-[10px] text-emerald-500 font-mono border border-slate-700 px-1.5 py-0.5 rounded bg-slate-800">v18.4</span>
                </div>
            </div>
            <div class="flex gap-3">
                <div class="relative">
                    <button onclick="toggleNotifPanel()" class="notif-btn w-10 h-10 bg-slate-800 text-slate-400 border border-slate-700 rounded-xl flex items-center justify-center hover:bg-slate-700 hover:text-white transition-all shadow-lg">
                        <i class="fas fa-bell"></i>
                        <span id="notif-badge" class="notif-badge">0</span>
                    </button>
                    <div id="notif-panel">
                        <div class="notif-header">
                            <span>PAGAMENTOS RECENTES</span>
                            <button onclick="toggleNotifPanel()" class="text-slate-500 hover:text-white"><i class="fas fa-times"></i></button>
                        </div>
                        <div id="notif-list" class="notif-list"></div>
                    </div>
                </div>

                <button onclick="refreshApp()" title="Atualizar Dados" class="w-10 h-10 bg-emerald-500/10 text-emerald-500 border border-emerald-500/30 rounded-xl flex items-center justify-center hover:bg-emerald-500 hover:text-white transition-all active:scale-95 shadow-lg">
                    <i id="refresh-icon" class="fas fa-sync-alt text-sm"></i>
                </button>
                <button onclick="window.location.reload()" title="Sair" class="w-10 h-10 bg-red-500/10 text-red-500 border border-red-500/30 rounded-xl flex items-center justify-center hover:bg-red-500 hover:text-white transition-all active:scale-95 shadow-lg">
                    <i class="fas fa-power-off text-sm"></i>
                </button>
            </div>
        </header>

        <div id="connection-status" class="hidden bg-yellow-500/20 text-yellow-200 text-xs text-center p-2 mb-2 mx-4 rounded-lg border border-yellow-500/50">‚è≥ Conectando...</div>
        <div id="error-alert" class="hidden bg-red-900/80 text-red-200 text-xs p-4 mb-2 mx-4 rounded-lg border border-red-500 shadow-xl font-mono break-all"></div>

        <div id="tab-home" class="tab-content active p-4 space-y-4">
            <div class="glass p-2 rounded-xl flex items-center gap-3 border border-slate-700 bg-slate-800">
                <i class="fas fa-calendar-alt text-emerald-500 ml-2"></i>
                <select id="dashboard-filter-month" onchange="calculateDashboard()" class="w-full bg-transparent text-sm font-bold text-white outline-none"></select>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-4 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border-l-4 border-l-emerald-500 relative group">
                    <div class="flex justify-between items-start">
                        <p class="text-slate-400 text-[10px] font-bold uppercase">Receita Real</p>
                        <button onclick="setMonthlyGoal()" class="text-emerald-500/50 hover:text-white transition-colors" title="Definir Meta"><i class="fas fa-pencil-alt text-xs"></i></button>
                    </div>
                    <h3 id="stat-paid-amount" class="text-xl font-bold text-emerald-400">R$ 0,00</h3>
                    <p id="goal-display" class="text-[9px] text-emerald-600 font-mono hidden">Meta: R$ 0,00</p>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 mt-2 overflow-hidden"><div id="revenue-progress" class="bg-emerald-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                </div>
                <div class="glass p-4 rounded-2xl border-l-4 border-l-blue-500">
                    <p class="text-slate-400 text-[10px] font-bold uppercase">RECEITA PREVISTA</p>
                    <h3 id="stat-projected" class="text-xl font-bold text-blue-400">R$ 0,00</h3>
                    <p class="text-[9px] text-slate-500 mt-1">Soma de Contratos</p>
                </div>
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-3 rounded-xl border border-red-500/30 bg-red-900/10">
                    <p class="text-red-400 text-[9px] uppercase font-bold"><i class="fas fa-clock mr-1"></i> Pendente (M√™s)</p>
                    <h4 id="stat-pending-money" class="text-lg font-bold text-white">R$ 0,00</h4>
                </div>
                <div class="glass p-3 rounded-xl border border-yellow-500/30 bg-yellow-900/10">
                    <p class="text-yellow-400 text-[9px] uppercase font-bold"><i class="fas fa-coins mr-1"></i> Lucro L√≠quido</p>
                    <h4 id="stat-profit" class="text-lg font-bold text-white">R$ 0,00</h4>
                </div>
            </div>
            
            <div class="glass rounded-3xl overflow-hidden border border-slate-700/50 mt-2">
                <div class="p-4 border-b border-slate-700 flex justify-between items-center bg-slate-800/30">
                    <h3 class="font-bold flex items-center gap-2 text-sm uppercase tracking-wider text-slate-300">
                        <i class="fas fa-exclamation-triangle text-yellow-400 text-sm"></i> <span id="pending-header-title">PEND√äNCIAS</span>
                    </h3>
                    <span id="badge-count" class="bg-yellow-600 text-white text-sm font-bold px-2.5 py-0.5 rounded-lg shadow-lg">0</span>
                </div>
                <div id="billing-queue" class="divide-y divide-slate-800 max-h-96 overflow-y-auto bg-slate-900/30 pb-12"></div>
            </div>
        </div>

        <div id="tab-clients" class="tab-content p-4 space-y-4">
            <div class="flex gap-2">
                <div class="relative flex-1"><i class="fas fa-search absolute left-4 top-3.5 text-slate-500"></i><input type="text" id="search-client" oninput="filterClients()" placeholder="Buscar..." class="w-full bg-slate-800 rounded-xl py-3 pl-11 pr-4 outline-none border border-slate-700 focus:border-blue-500 text-white"></div>
                <button onclick="openModal()" class="bg-blue-600 w-12 rounded-xl text-white shadow-lg"><i class="fas fa-plus"></i></button>
            </div>
            <div id="clients-list" class="space-y-3 pb-20"></div>
        </div>

        <div id="tab-reports" class="tab-content p-4">
            <div class="glass rounded-2xl overflow-hidden border border-slate-700">
                <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex gap-2">
                    <select id="report-filter-month" onchange="renderReportTable()" class="w-1/2 bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded-lg py-2 pl-2 outline-none"></select>
                    <select id="report-filter-product" onchange="renderReportTable()" class="w-1/2 bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded-lg py-2 pl-2 outline-none"><option value="all">Planos: Todos</option></select>
                </div>
                <div class="report-container"><table class="report-table w-full"><thead id="report-header"></thead><tbody id="report-body"></tbody></table></div>
            </div>
        </div>

        <div id="tab-config" class="tab-content p-4">
            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-300">Planos</h3><button onclick="openProductModal()" class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded-lg hover:bg-emerald-500"><i class="fas fa-plus mr-1"></i> Novo</button></div>
            <div id="products-list" class="space-y-2 pb-20"></div>
        </div>

        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-slate-700 flex justify-around p-3 z-40 bg-slate-900/90 backdrop-blur-md">
            <button onclick="showTab('tab-home')" class="nav-item text-blue-500 flex flex-col items-center" data-tab="tab-home"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px]">In√≠cio</span></button>
            <button onclick="showTab('tab-reports')" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-reports"><i class="fas fa-chart-bar text-xl mb-1"></i><span class="text-[10px]">Relat√≥rios</span></button>
            <button onclick="showTab('tab-clients')" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-clients"><i class="fas fa-users text-xl mb-1"></i><span class="text-[10px]">Clientes</span></button>
            <button onclick="showTab('tab-config')" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-config"><i class="fas fa-tags text-xl mb-1"></i><span class="text-[10px]">Planos</span></button>
        </nav>

        <div id="chat-widget">
            <div id="chat-window">
                <div class="bg-slate-900 p-3 border-b border-slate-700 flex justify-between items-center shrink-0">
                    <h4 class="text-xs font-bold text-emerald-400 flex items-center gap-2"><span class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></span> BoxPower AI</h4>
                    <button onclick="toggleChat()" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button>
                </div>
                <div id="chat-messages" class="bg-slate-800/50">
                    <div class="msg-bot">
                        üëã <b>Ol√°! Que bom te ver por aqui.</b><br>
                        Estou pronto para organizar suas finan√ßas! üöÄ<br><br>
                        Posso te ajudar a <b>cadastrar clientes</b>, <b>lan√ßar pagamentos</b> ou <b>gerar Pix</b> num piscar de olhos.<br><br>
                        O que vamos fazer agora?
                    </div>
                </div>
                <div class="p-3 bg-slate-900 border-t border-slate-700 flex gap-2 shrink-0">
                    <input type="text" id="chat-input" placeholder="Digite..." class="flex-1 bg-slate-800 rounded-lg px-3 py-2 text-xs text-white border border-slate-700 outline-none focus:border-emerald-500 transition-all" onkeypress="handleChatKey(event)">
                    <button onclick="sendChat()" class="bg-emerald-600 w-10 h-8 rounded-lg text-white hover:bg-emerald-500 shadow-lg active:scale-95"><i class="fas fa-paper-plane text-xs"></i></button>
                </div>
            </div>
            <button onclick="toggleChat()" class="bg-blue-600 w-14 h-14 rounded-full shadow-2xl flex items-center justify-center text-white hover:bg-blue-500 transition-all active:scale-90 border-2 border-blue-400 z-50"><i class="fas fa-comment-dots text-2xl"></i></button>
        </div>

        <div id="client-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 w-full max-w-md rounded-3xl border border-slate-700 p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                <h3 id="modal-title" class="text-xl font-bold mb-4">Cliente</h3>
                <input type="hidden" id="modal-client-id">
                <div class="space-y-3">
                    <input type="text" id="modal-name" placeholder="Nome" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white">
                    <div class="flex gap-2">
                        <input type="number" id="modal-due" placeholder="Dia Venc." class="w-1/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white">
                        <input type="text" id="modal-whatsapp" oninput="maskPhone(this)" placeholder="WhatsApp" class="w-2/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white">
                    </div>
                    <div class="flex gap-2">
                        <select id="modal-product" onchange="productChanged()" class="w-2/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white"></select>
                        <input type="number" id="modal-price" step="0.01" placeholder="R$" class="w-1/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none font-bold text-emerald-400">
                    </div>
                    <div class="flex gap-2">
                         <select id="modal-status" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none font-bold text-white"><option value="true" class="text-green-400">Ativo</option><option value="false" class="text-red-400">Inativo</option></select>
                    </div>
                </div>
                <div id="history-section" class="mt-6 border-t border-slate-700 pt-4 hidden">
                    <div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-slate-400 uppercase">Hist√≥rico</h4><button onclick="openHistoryForm()" class="text-xs bg-slate-700 px-3 py-1.5 rounded-lg hover:bg-slate-600 border border-slate-600 transition-colors"><i class="fas fa-plus mr-1 text-blue-400"></i> Lan√ßar</button></div>
                    <div id="history-form-container" class="bg-slate-800 p-3 rounded-xl border border-blue-500/30 mb-2"><input type="hidden" id="hist-id"><div class="flex gap-2 mb-2"><div class="w-1/2"><label class="text-[9px] text-slate-500 uppercase font-bold">Data</label><input type="date" id="hist-date" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white"></div><div class="w-1/2"><label class="text-[9px] text-slate-500 uppercase font-bold">Valor (R$)</label><input type="number" id="hist-amount" step="0.01" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white font-bold text-emerald-400"></div></div><div class="flex gap-2"><button onclick="closeHistoryForm()" class="flex-1 bg-slate-700 text-xs py-2 rounded text-slate-300">Cancelar</button><button onclick="saveHistory()" class="flex-1 bg-blue-600 text-xs py-2 rounded text-white font-bold">Salvar Pagamento</button></div></div>
                    <div id="history-list" class="bg-slate-800/50 rounded-xl p-2 space-y-1 max-h-40 overflow-y-auto text-xs border border-slate-700/50"></div>
                </div>
                <div class="flex gap-3 mt-6"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-800 text-slate-400">Cancelar</button><button onclick="saveClient()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg">Salvar</button></div>
            </div>
        </div>

        <div id="product-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 p-6 shadow-2xl">
                <h3 id="product-modal-title" class="text-lg font-bold mb-4">Gerenciar Plano</h3>
                <input type="hidden" id="prod-id">
                <div class="space-y-3"><div><label class="text-[10px] text-slate-500 uppercase font-bold">Nome do Plano</label><input type="text" id="prod-name" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white"></div><div><label class="text-[10px] text-slate-500 uppercase font-bold">Pre√ßo (R$)</label><input type="number" id="prod-price" step="0.01" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white font-bold text-emerald-400"></div></div>
                <div class="flex gap-3 mt-6"><button onclick="document.getElementById('product-modal').classList.add('hidden')" class="flex-1 py-2.5 rounded-xl bg-slate-800 text-slate-400">Cancelar</button><button onclick="saveProduct()" class="flex-1 py-2.5 rounded-xl bg-emerald-600 text-white font-bold">Salvar</button></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" onload="initSystem()" defer></script>
    <script>
        const SUPABASE_URL = "https://epwmoicgvuprzkcpxjoy.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwd21vaWNndnVwcnprY3B4am95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDAxMjgsImV4cCI6MjA4NTMxNjEyOH0.pXcCWqGQSS6YMIZeIyfAaGlNaW6Mx2hfDQtVrX4zues";
        
        let sb = null, allClients = [], allProducts = [], historyData = [], isSystemReady = false, chatState = null;
        let currentMonthGoal = 0;

        const formatCurrency = (val) => {
            if (val === undefined || val === null || isNaN(val)) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        };

        function showError(msg) {
            const errDiv = document.getElementById('error-alert');
            const conn = document.getElementById('connection-status');
            if(conn) conn.classList.add('hidden');
            if(errDiv) { errDiv.innerText = `‚ö†Ô∏è ${msg}`; errDiv.classList.remove('hidden'); }
            console.error(msg);
        }

        // --- AUTH & SYSTEM ---
        function performLogin() {
            if(document.getElementById('pin-input').value === "1234") {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden');
                setTimeout(() => document.getElementById('main-content').style.opacity = "1", 50);
                if(isSystemReady) loadAllData();
                else document.getElementById('connection-status').classList.remove('hidden');
            } else alert("PIN Incorreto");
        }

        function initSystem() {
            if(window.supabase) {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                isSystemReady = true;
                document.getElementById('connection-status').classList.add('hidden');
                
                if(document.getElementById('login-screen').style.display === 'none') {
                    loadAllData();
                }

                sb.channel('db-changes')
                .on(
                    'postgres_changes',
                    { event: '*', schema: 'public', table: 'payment_history' },
                    (payload) => {
                        const isNewApproved = (payload.eventType === 'INSERT' && payload.new.status === 'approved');
                        const isUpdatedApproved = (payload.eventType === 'UPDATE' && payload.new.status === 'approved' && payload.old.status !== 'approved');

                        if (isNewApproved || isUpdatedApproved) {
                            const client = allClients.find(c => c.id === payload.new.client_id);
                            const clientName = client ? client.name : 'Cliente/Pagamento';
                            const valor = formatCurrency(payload.new.amount);
                            showNotification(clientName, valor);
                            refreshApp(); 
                        }
                    }
                )
                .subscribe();
            }
        }

        async function refreshApp() {
            const icon = document.getElementById('refresh-icon');
            if(icon) icon.classList.add('fa-spin'); 
            await loadAllData();
            if(icon) setTimeout(() => icon.classList.remove('fa-spin'), 1000); 
        }

        async function loadAllData() {
            try {
                await Promise.all([fetchProducts(), fetchClients(), fetchFullHistory()]);
                const errDiv = document.getElementById('error-alert');
                if(errDiv) errDiv.classList.add('hidden');
                populateMonthFilter(); populateDashboardFilter(); 
                await calculateDashboard(); 
                renderReportTable();
                updateNotificationBadge();
            } catch (error) { showError("Falha ao carregar dados: " + error.message); }
        }

        async function fetchProducts() {
            if(!sb) return;
            const { data, error } = await sb.from('products').select('*').order('name');
            if(error) throw error;
            allProducts = data || [];
            updateProductUI();
        }

        function updateProductUI() {
            const s = document.getElementById('modal-product');
            if(s) s.innerHTML = '<option value="">Produto</option>' + allProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            const r = document.getElementById('report-filter-product');
            if(r) { const v = r.value; r.innerHTML = '<option value="all">Planos: Todos</option>' + allProducts.map(p => `<option value="${p.id}">${p.name}</option>`).join(''); r.value = v; }
            
            const l = document.getElementById('products-list');
            if(l) l.innerHTML = allProducts.map(p => `<div class="glass p-3 rounded-xl flex justify-between items-center group"><div><span class="block text-sm font-bold text-white">${p.name}</span><span class="text-xs text-emerald-400 font-mono">${formatCurrency(p.price)}</span></div><div class="flex gap-2 opacity-60 group-hover:opacity-100 transition-opacity"><button onclick="editProduct('${p.id}')" class="bg-slate-800 w-8 h-8 rounded flex items-center justify-center hover:text-blue-400"><i class="fas fa-pen text-xs"></i></button><button onclick="deleteProduct('${p.id}')" class="bg-slate-800 w-8 h-8 rounded flex items-center justify-center hover:text-red-400"><i class="fas fa-trash text-xs"></i></button></div></div>`).join('');
        }

        async function fetchClients() {
            if(!sb) return;
            let { data, error } = await sb.from('clients').select('*, products(*)').order('name');
            if(error) { const f = await sb.from('clients').select('*').order('name'); if(f.error) throw f.error; data = f.data; }
            allClients = data || [];
            renderClients(allClients);
        }

        async function fetchFullHistory() {
            if(!sb) return;
            const { data, error } = await sb.from('payment_history').select('*');
            if(error) throw error;
            historyData = data || [];
        }

        function populateDashboardFilter() {
            const s = document.getElementById('dashboard-filter-month'); if(!s) return;
            const now = new Date(); let opts = '';
            for(let i=-6; i<=6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const val = d.toISOString().slice(0, 7); 
                const label = d.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});
                opts += `<option value="${val}" ${i===0?'selected':''}>${label}</option>`;
            }
            s.innerHTML = opts;
        }

        // --- DASHBOARD ---
        async function calculateDashboard() {
            const v = document.getElementById('dashboard-filter-month').value;
            let t = new Date(); if(v) { const [y, m] = v.split('-'); t = new Date(parseInt(y), parseInt(m)-1, 1); }
            const active = allClients.filter(c => c.active);
            const f = new Date(t.getFullYear(), t.getMonth(), 1).toISOString();
            const l = new Date(t.getFullYear(), t.getMonth()+1, 0, 23, 59, 59).toISOString();
            const monthKey = v || t.toISOString().slice(0, 7);

            currentMonthGoal = 0;
            try {
                const { data } = await sb.from('monthly_goals').select('target_amount').eq('month', monthKey).single();
                if(data) currentMonthGoal = Number(data.target_amount);
            } catch(e) {}

            const goalDisplay = document.getElementById('goal-display');
            if(currentMonthGoal > 0) {
                goalDisplay.innerText = `Meta: ${formatCurrency(currentMonthGoal)}`;
                goalDisplay.classList.remove('hidden');
            } else {
                goalDisplay.classList.add('hidden');
            }
            
            const rev = historyData.filter(h => 
                h.payment_date >= f && 
                h.payment_date <= l && 
                (h.status === 'approved' || !h.status)
            ).reduce((a,c) => a + (Number(c.amount)||0), 0);

            const proj = active.reduce((a,c) => a + (c.agreed_price || c.products?.price || 0), 0);
            
            const target = currentMonthGoal > 0 ? currentMonthGoal : proj;
            const progress = target > 0 ? (rev / target) * 100 : 0;
            if(document.getElementById('revenue-progress')) document.getElementById('revenue-progress').style.width = `${Math.min(progress, 100)}%`;
            
            if(document.getElementById('stat-paid-amount')) document.getElementById('stat-paid-amount').innerText = formatCurrency(rev);
            if(document.getElementById('stat-projected')) document.getElementById('stat-projected').innerText = formatCurrency(proj);
            
            const pendMonthValue = active.reduce((acc, c) => {
                 const totalPaid = historyData
                    .filter(h => h.client_id === c.id && h.payment_date >= f && h.payment_date <= l && (h.status === 'approved' || !h.status))
                    .reduce((sum, h) => sum + (Number(h.amount)||0), 0);
                 const price = c.agreed_price || c.products?.price || 0;
                 return acc + Math.max(0, price - totalPaid);
            }, 0);

            if(document.getElementById('stat-pending-money')) document.getElementById('stat-pending-money').innerText = formatCurrency(pendMonthValue);
            
            const now = new Date();
            const isPast = t < new Date(now.getFullYear(), now.getMonth(), 1);
            const isCurr = (t.getMonth() === now.getMonth() && t.getFullYear() === now.getFullYear());

            const pendList = active.filter(c => {
                const totalPaid = historyData
                    .filter(h => h.client_id === c.id && h.payment_date >= f && h.payment_date <= l && (h.status === 'approved' || !h.status))
                    .reduce((sum, h) => sum + (Number(h.amount)||0), 0);
                
                const price = c.agreed_price || c.products?.price || 0;
                if(totalPaid >= price && price > 0) return false;
                if(isPast) return true;
                if(isCurr) return c.due_day <= now.getDate();
                return false;
            }).sort((a,b) => (b.due_day||0) - (a.due_day||0)); 

            const totalListPending = pendList.reduce((acc, c) => {
                const totalPaid = historyData.filter(h => h.client_id === c.id && h.payment_date >= f && h.payment_date <= l && (h.status === 'approved' || !h.status)).reduce((sum, h) => sum + (Number(h.amount)||0), 0);
                return acc + Math.max(0, (c.agreed_price || c.products?.price || 0) - totalPaid);
            }, 0);

            if(document.getElementById('pending-header-title')) document.getElementById('pending-header-title').innerText = `PEND√äNCIAS (${formatCurrency(totalListPending)})`;
            if(document.getElementById('badge-count')) document.getElementById('badge-count').innerText = pendList.length;
            
            const qList = document.getElementById('billing-queue');
            if(qList) {
                if(pendList.length === 0) qList.innerHTML = `<div class="p-8 text-center text-slate-500">${isPast ? "Nenhuma pend√™ncia!" : "Tudo em dia por enquanto!"}</div>`;
                else qList.innerHTML = pendList.map(c => {
                    const wpp = c.whatsapp ? c.whatsapp.replace(/\D/g,'') : '';
                    const totalPaid = historyData.filter(h => h.client_id === c.id && h.payment_date >= f && h.payment_date <= l && (h.status === 'approved' || !h.status)).reduce((sum, h) => sum + (Number(h.amount)||0), 0);
                    const price = c.agreed_price || c.products?.price || 0;
                    const remaining = Math.max(0, price - totalPaid);
                    const prodName = c.products?.name || 'S/ Plano';
                    
                    return `<div class="p-4 flex justify-between items-center hover:bg-slate-800 transition border-b border-slate-800/50">
                        <div>
                            <h4 class="font-bold text-base text-white tracking-wide">${c.name}</h4>
                            <p class="text-[12px] text-slate-400 mt-1 font-mono">
                                <span class="text-yellow-500">Dia ${c.due_day}</span> ‚Ä¢ Resta <span class="text-white font-bold">${formatCurrency(remaining)}</span> ‚Ä¢ ${prodName}
                            </p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="editClient('${c.id}')" class="bg-slate-700 text-blue-400 w-10 h-10 rounded-xl flex items-center justify-center hover:text-white transition shadow-lg"><i class="fas fa-hand-holding-usd"></i></button>
                            <a href="https://api.whatsapp.com/send?phone=${wpp}" target="_blank" class="bg-emerald-600 text-white w-10 h-10 rounded-xl flex items-center justify-center hover:bg-emerald-500 transition shadow-lg"><i class="fab fa-whatsapp text-lg"></i></a>
                        </div>
                    </div>`;
                }).join('');
            }
        }

        async function setMonthlyGoal() {
            const v = document.getElementById('dashboard-filter-month').value;
            if(!v) return;
            
            const newVal = prompt(`Definir meta para ${v}? (Digite apenas n√∫meros)`, currentMonthGoal || 0);
            if(newVal !== null) {
                const amount = parseFloat(newVal.replace(',','.'));
                if(isNaN(amount)) return alert("Valor inv√°lido");
                const { error } = await sb.from('monthly_goals').upsert({ month: v, target_amount: amount });
                if(error) alert("Erro ao salvar meta: " + error.message);
                else { refreshApp(); }
            }
        }

        function populateMonthFilter() {
            const s = document.getElementById('report-filter-month'); if(!s) return;
            const now = new Date(); let opts = '';
            for(let i=-6; i<=6; i++) {
                const d = new Date(now.getFullYear(), now.getMonth() + i, 1);
                const val = d.toISOString().slice(0, 7); 
                const label = d.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});
                opts += `<option value="${val}" ${i===0?'selected':''}>${label}</option>`;
            }
            s.innerHTML = opts;
        }

        function renderReportTable() {
            const v = document.getElementById('report-filter-month').value; if(!v) return;
            const [y, m] = v.split('-'); const d = new Date(parseInt(y), parseInt(m)-1, 1);
            const f = new Date(d.getFullYear(), d.getMonth(), 1).toISOString();
            const l = new Date(d.getFullYear(), d.getMonth()+1, 0, 23, 59, 59).toISOString();
            const fp = document.getElementById('report-filter-product').value;
            
            let lst = allClients.filter(c => { if(!c.active) return false; if(fp !== 'all' && c.product_id !== fp) return false; return true; }).sort((a,b) => (a.due_day||0) - (b.due_day||0));
            
            let tot = 0; 
            lst.forEach(c => { 
                const sum = historyData
                    .filter(x => x.client_id === c.id && x.payment_date >= f && x.payment_date <= l && (x.status === 'approved' || !x.status))
                    .reduce((acc, x) => acc + (Number(x.amount)||0), 0);
                tot += sum; 
            });
            
            document.getElementById('report-header').innerHTML = `<tr><th class="sticky-col text-left text-white bg-slate-900 border-r border-slate-700">CLIENTES (${lst.length})</th><th colspan="3" class="text-emerald-400 bg-slate-900 border-l border-slate-700 font-bold tracking-widest text-[10px]">${d.toLocaleDateString('pt-BR',{month:'short'}).toUpperCase()} | ${formatCurrency(tot)}</th></tr><tr><th class="sticky-col bg-slate-900 border-r border-slate-700"></th><th class="sub-header text-blue-300 border-l border-slate-700">Valor</th><th class="sub-header text-emerald-300 border-l border-slate-800">Dia</th><th class="sub-header text-emerald-300">Pago</th></tr>`;
            
            document.getElementById('report-body').innerHTML = lst.length === 0 ? `<tr><td colspan="4" class="p-4 text-center text-slate-500">Nada encontrado.</td></tr>` : lst.map(c => { 
                const totalPaid = historyData
                    .filter(h => h.client_id === c.id && h.payment_date >= f && h.payment_date <= l && (h.status === 'approved' || !h.status))
                    .reduce((sum, h) => sum + (Number(h.amount)||0), 0);
                
                const pending = historyData.find(h => h.client_id === c.id && h.payment_date >= f && h.payment_date <= l && h.status === 'pending');
                const price = c.agreed_price || c.products?.price || 0;

                let statusColor = 'text-slate-700'; 
                if(totalPaid >= price && price > 0) statusColor = 'text-emerald-400 font-bold bg-emerald-500/5'; 
                else if(totalPaid > 0) statusColor = 'text-yellow-400 font-bold'; 
                else if(pending) statusColor = 'text-blue-400 animate-pulse'; 

                return `<tr><td class="sticky-col text-xs truncate border-r border-slate-700" onclick="editClient('${c.id}')"><span class="bg-slate-700 px-1 rounded mr-1">${c.due_day||'?'}</span>${c.name}</td><td class="text-slate-500 text-[9px] border-l border-slate-800">${formatCurrency(price)}</td><td class="text-slate-500 text-[9px] border-l border-slate-800">-</td><td class="${statusColor} text-[9px]">${totalPaid > 0 ? formatCurrency(totalPaid) : (pending ? '‚è≥' : '-')}</td></tr>`; 
            }).join('');
        }

        // CRUD
        function openProductModal() { document.getElementById('prod-id').value=''; document.getElementById('prod-name').value=''; document.getElementById('prod-price').value=''; document.getElementById('product-modal').classList.remove('hidden'); }
        async function saveProduct(){ const id=document.getElementById('prod-id').value, d={name:document.getElementById('prod-name').value, price:document.getElementById('prod-price').value}; if(!d.name)return; if(id)await sb.from('products').update(d).eq('id',id); else await sb.from('products').insert([d]); document.getElementById('product-modal').classList.add('hidden'); await fetchProducts(); calculateDashboard(); }
        function editProduct(id){ const p=allProducts.find(x=>x.id===id); if(!p)return; document.getElementById('prod-id').value=p.id; document.getElementById('prod-name').value=p.name; document.getElementById('prod-price').value=p.price; document.getElementById('product-modal').classList.remove('hidden'); }
        async function deleteProduct(id){ if(confirm('Apagar plano?')) { await sb.from('products').delete().eq('id',id); fetchProducts(); } }
        function renderClients(l) { const t=document.getElementById('search-client').value.toLowerCase(); document.getElementById('clients-list').innerHTML=l.filter(c=>c.name.toLowerCase().includes(t)).map(c=>`<div class="glass p-4 rounded-xl flex justify-between items-center border-l-4 ${c.active?'border-l-emerald-500':'border-l-red-500'}"><div onclick="editClient('${c.id}')" class="flex-1"><h4 class="font-bold text-sm text-white">${c.name}</h4><div class="flex gap-2 text-[10px] text-slate-400 mt-1"><span class="bg-slate-800 px-2 py-0.5 rounded">Dia ${c.due_day}</span><span>‚Ä¢ ${c.products?.name||'S/ Plano'}</span></div></div><div class="flex gap-2"><button onclick="deleteClient('${c.id}')" class="text-slate-600 hover:text-red-400 p-2"><i class="fas fa-trash"></i></button><button onclick="editClient('${c.id}')" class="bg-slate-800 text-blue-400 w-8 h-8 rounded-lg"><i class="fas fa-pen"></i></button></div></div>`).join(''); }
        function filterClients(){ renderClients(allClients); }
        function openModal(){ document.getElementById('modal-client-id').value=''; document.getElementById('modal-name').value=''; document.getElementById('modal-due').value=''; document.getElementById('modal-whatsapp').value=''; document.getElementById('modal-price').value=''; document.getElementById('modal-status').value='true'; document.getElementById('history-section').classList.add('hidden'); document.getElementById('client-modal').classList.remove('hidden'); }
        function closeModal(){ document.getElementById('client-modal').classList.add('hidden'); }
        function showTab(id){ document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); document.querySelectorAll('.nav-item').forEach(n=>{n.classList.remove('text-blue-500');n.classList.add('text-slate-500')}); document.getElementById(id).classList.add('active'); document.querySelector(`button[data-tab="${id}"]`)?.classList.replace('text-slate-500','text-blue-500'); }
        
        function maskPhone(input) {
            let val = input.value.replace(/\D/g,'');
            if(val.length > 11) val = val.slice(0, 11);
            if(val.length > 6) val = val.replace(/(\d{2})(\d{5})(\d{4})/,"($1) $2-$3");
            else if(val.length > 2) val = val.replace(/(\d{2})(\d+)/,"($1) $2");
            input.value = val;
        }

        function productChanged() {
            const pid = document.getElementById('modal-product').value;
            const priceInput = document.getElementById('modal-price');
            const prod = allProducts.find(p => p.id === pid);
            if (prod) priceInput.value = prod.price;
        }

        async function editClient(id){ 
            const c=allClients.find(x=>x.id===id); if(!c)return; 
            document.getElementById('modal-client-id').value=c.id; 
            document.getElementById('modal-name').value=c.name; 
            document.getElementById('modal-due').value=c.due_day; 
            document.getElementById('modal-whatsapp').value=c.whatsapp; 
            document.getElementById('modal-product').value=c.product_id; 
            document.getElementById('modal-price').value = c.agreed_price || (c.products ? c.products.price : '');
            document.getElementById('modal-status').value=c.active; 
            document.getElementById('history-section').classList.remove('hidden'); 
            renderHistoryList(id); 
            document.getElementById('client-modal').classList.remove('hidden'); 
        }

        async function saveClient(){ 
            const id=document.getElementById('modal-client-id').value;
            const d={
                name:document.getElementById('modal-name').value, 
                due_day:parseInt(document.getElementById('modal-due').value), 
                whatsapp:document.getElementById('modal-whatsapp').value, 
                product_id:document.getElementById('modal-product').value||null, 
                agreed_price: document.getElementById('modal-price').value || null, 
                active:document.getElementById('modal-status').value==='true'
            }; 
            if(id)await sb.from('clients').update(d).eq('id',id); 
            else await sb.from('clients').insert([d]); 
            closeModal(); loadAllData(); 
        }

        async function deleteClient(id){ if(confirm('Excluir?')) { try { await sb.from('payment_history').delete().eq('client_id',id); await sb.from('clients').delete().eq('id',id); loadAllData(); } catch(e){ alert("Erro ao excluir (Bloqueado pelo RLS?)"); } } }
        
        function renderHistoryList(cid){ 
            const h=historyData.filter(x=>x.client_id===cid).sort((a,b)=>new Date(b.payment_date)-new Date(a.payment_date)); 
            document.getElementById('history-list').innerHTML=h.map(i=> {
                const isPending = i.status === 'pending';
                const approveBtn = isPending ? `<button onclick="forceApprove('${i.id}','${cid}')" title="For√ßar Aprova√ß√£o" class="text-emerald-400 hover:text-emerald-200 mr-2"><i class="fas fa-check-circle"></i></button>` : '';
                return `<div class="flex justify-between border-b border-slate-700/50 p-1 text-xs"><span class="text-slate-400">${new Date(i.payment_date).toLocaleDateString('pt-BR')} ${isPending ? '(‚è≥)' : ''}</span><div>${approveBtn}<span class="${isPending ? 'text-yellow-400' : 'text-emerald-400'} font-bold mr-2">${formatCurrency(i.amount)}</span> <button onclick="deleteHistory('${i.id}','${cid}')" class="text-red-400 hover:text-red-200">x</button></div></div>`;
            }).join(''); 
        }

        async function forceApprove(hid, cid) {
            if(confirm("Confirmar que o cliente pagou manualmente?")) {
                await sb.from('payment_history').update({ status: 'approved' }).eq('id', hid);
                await fetchFullHistory();
                renderHistoryList(cid);
                calculateDashboard();
            }
        }

        function openHistoryForm(){ document.getElementById('history-form-container').classList.add('open'); document.getElementById('hist-date').value=new Date().toISOString().split('T')[0]; }
        function closeHistoryForm(){ document.getElementById('history-form-container').classList.remove('open'); }
        async function saveHistory(){ const cid=document.getElementById('modal-client-id').value, d={client_id:cid, amount:document.getElementById('hist-amount').value, payment_date:document.getElementById('hist-date').value+'T12:00:00Z', method:'manual', status: 'approved'}; await sb.from('payment_history').insert([d]); await fetchFullHistory(); renderHistoryList(cid); calculateDashboard(); renderReportTable(); closeHistoryForm(); }
        async function deleteHistory(hid,cid){ if(confirm('Apagar?')){ try { await sb.from('payment_history').delete().eq('id',hid); await fetchFullHistory(); renderHistoryList(cid); calculateDashboard(); renderReportTable(); } catch(e) { alert("Erro: Exclus√£o bloqueada por seguran√ßa (RLS)."); } } }

        function toggleChat(){ const w=document.getElementById('chat-window'); w.style.display=(w.style.display==='flex'?'none':'flex'); if(w.style.display==='flex')document.getElementById('chat-input').focus(); }
        function handleChatKey(e){ if(e.key==='Enter') sendChat(); }
        window.sendChat = function(txt = null) { 
            const input = document.getElementById('chat-input');
            const text = txt || input.value.trim();
            if(!text) return;
            addMsg('user', text);
            input.value = ''; input.focus();
            processCommand(text);
        }
        function addMsg(type, html) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = type === 'user' ? 'msg-user' : 'msg-bot';
            if(html.includes('‚úÖ')) div.classList.add('msg-success');
            if(html.includes('‚ùå') || html.includes('‚ö†Ô∏è')) div.classList.add('msg-error');
            div.innerHTML = html;
            container.appendChild(div);
            container.scrollTop = container.scrollHeight;
            setTimeout(() => container.scrollTop = container.scrollHeight, 100);
        }

        function normalizeText(text) {
            return text.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
        }

        function getWhatsappLink(phone, clientName, code, amount) {
            if(!phone) return '#';
            const cleanPhone = phone.replace(/\D/g,'');
            const text = `Ol√° ${clientName}! Segue a chave Pix para pagamento de R$ ${amount.toFixed(2)} do BoxPower.%0A%0ACopie e cole o c√≥digo abaixo no seu banco:%0A%0A${code}`;
            return `https://api.whatsapp.com/send?phone=${cleanPhone}&text=${text}`;
        }

        async function generatePixPayment(clientObj, amount) {
            addMsg('bot', `‚è≥ Iniciando Pix de <b>R$ ${amount}</b>...`);
            try {
                const { data: dbData, error: dbErr } = await sb.from('payment_history').insert([{
                    client_id: clientObj.id, amount: amount, payment_date: new Date().toISOString(), method: 'pix_mercadopago', status: 'creating' 
                }]).select().single();

                if (dbErr) throw new Error("Falha ao criar registro no banco.");

                const { data: apiData, error: apiErr } = await sb.functions.invoke('super-responder', {
                    body: { amount: amount, description: `BoxPower - ${clientObj.name}`, payer_email: 'financeiro@boxpower.app' }
                });

                if (apiErr || (apiData && apiData.error)) {
                    await sb.from('payment_history').update({ status: 'error' }).eq('id', dbData.id);
                    throw new Error(apiData?.error || apiErr?.message || "Erro na API MP");
                }

                await sb.from('payment_history').update({ mp_id: apiData.id.toString(), status: 'pending' }).eq('id', dbData.id);
                await fetchFullHistory();
                renderReportTable(); 
                const wppLink = getWhatsappLink(clientObj.whatsapp, clientObj.name, apiData.qr_code, amount);
                const chatHtml = `<div class="flex flex-col gap-2 bg-slate-900 p-3 rounded-xl border border-emerald-500/30"><span class="text-xs font-bold text-emerald-400 text-center uppercase tracking-widest mb-1">‚úÖ Pix Gerado</span><img src="data:image/png;base64,${apiData.qr_code_base64}" class="w-48 h-48 rounded-lg mx-auto border-4 border-white mix-blend-screen" style="image-rendering: pixelated;"><textarea id="pix-copy-${apiData.id}" class="hidden">${apiData.qr_code}</textarea><div class="grid grid-cols-2 gap-2 mt-2"><button onclick="copyPix('${apiData.id}')" class="bg-slate-700 text-white py-2 rounded-lg font-bold text-[10px] hover:bg-slate-600 transition flex items-center justify-center gap-2"><i class="fas fa-copy"></i> Copiar C√≥digo</button><a href="${wppLink}" target="_blank" class="bg-emerald-600 text-white py-2 rounded-lg font-bold text-[10px] hover:bg-emerald-500 transition flex items-center justify-center gap-2"><i class="fab fa-whatsapp"></i> Enviar Zap</a></div></div>`;
                addMsg('bot', chatHtml);
            } catch (err) { addMsg('bot', `‚ùå Falha: ${err.message}`); console.error(err); }
        }

        window.copyPix = function(id) { const text = document.getElementById(`pix-copy-${id}`).value; navigator.clipboard.writeText(text).then(() => { alert("C√≥digo Pix copiado!"); }); }

        // --- C√âREBRO CORRIGIDO V18.4 (BUSCA SEM ERRO NO 'O') ---
        async function processCommand(text) {
            const originalText = text; 
            // 1. Limpeza pesada: Remove acentos E pontua√ß√£o (?, !, .) para n√£o atrapalhar
            const lower = normalizeText(text).replace(/[?!.,]/g, "");

            // --- CONFIRMA√á√ïES ---
            if (chatState) {
                if (['sim','s','confirmar','ok','pode','vai'].includes(lower)) {
                    if (chatState.type === 'add') {
                        const { error } = await sb.from('clients').insert([chatState.payload]);
                        if(!error) { await fetchClients(); calculateDashboard(); renderReportTable(); addMsg('bot', `‚úÖ Cliente <b>${chatState.payload.name}</b> cadastrado!`); } else addMsg('bot', `‚ùå Erro: ${error.message}`);
                    }
                    else if (chatState.type === 'pay') {
                        const { error } = await sb.from('payment_history').insert([chatState.payload]);
                        if(!error) { await fetchFullHistory(); calculateDashboard(); renderReportTable(); addMsg('bot', `‚úÖ Pagamento registrado.`); }
                    }
                    else if (chatState.type === 'del') {
                        try { await sb.from('payment_history').delete().eq('client_id', chatState.id); await sb.from('clients').delete().eq('id', chatState.id); await loadAllData(); addMsg('bot', `‚úÖ Cliente removido.`); } catch(e) { addMsg('bot', `‚ùå Erro ao excluir (RLS).`); }
                    }
                    else if (chatState.type === 'gen_pix') { generatePixPayment(chatState.payload.client, chatState.payload.amount); chatState = null; return; }
                } else { addMsg('bot', 'üö´ Cancelado.'); } 
                chatState = null; return;
            }

            // --- INTELIG√äNCIA ---
            let intent = 'UNKNOWN';
            
            if (lower.match(/(novo|cria|add|cadastr|insir|inclu|adicion|bota)/)) intent = 'ADD';
            else if (lower.match(/(pagou|recebi|pg|lan√ßa|quitou)/)) intent = 'PAY';
            else if (lower.match(/(exclua|apague|delete|remove)/)) intent = 'DEL';
            else if (lower.match(/(cobre|cobrar|gere|gera|pix|fatura)/)) intent = 'CHARGE';
            else if (lower.match(/(tem|existe|h√°|quem|busca|procura|consultar|ver|ache|encontre|status|situacao)/)) intent = 'SEARCH';

            if (intent === 'UNKNOWN') { 
                if (text.split(' ').length > 1) intent = 'SEARCH';
                else { addMsg('bot', "ü§î Tente: 'Cobrar T√∫lio', 'Cadastre Ana 90', 'Tem Tokart?' ou 'Jo√£o pagou'."); return; }
            }

            // --- EXECU√á√ÉO ---
            if (intent === 'ADD') {
                let day = null, price = null, product = null, productID = null;
                const dayMatch = text.match(/(?:venc|vcm|vc|dt|dia)[a-z]*\W*(\d+)/i); if (dayMatch) day = parseInt(dayMatch[1]);
                let cleanText = text.replace(/(?:venc|vcm|vc|dt|dia)[a-z]*\W*(\d+)/gi, " ");
                const priceMatch = cleanText.match(/(?:R\$|pagando|valor)?\s*(\d+[.,]\d{2}|\d+)/i); if (priceMatch) { price = parseFloat(priceMatch[1].replace(',', '.')); cleanText = cleanText.replace(priceMatch[0], " "); }
                for (let p of allProducts) { if (lower.includes(normalizeText(p.name))) { product = p.name; productID = p.id; const regexProd = new RegExp(p.name, "gi"); cleanText = cleanText.replace(regexProd, " "); break; } }
                let name = cleanText.replace(/^(cadastre|cadastrei|novo|cria|adiciona|inclua|insira)\s+/i, "").replace(/[.,-]/g, " ").trim();
                name = name.replace(/\s+\b(com|o|a|de|e|pagando)\b\s+/gi, " ");
                if(product) name = name.replace(new RegExp(product, "gi"), "");
                if (!name || name.length < 2) return addMsg('bot', "‚ö†Ô∏è N√£o entendi o nome.");
                if (!day) return addMsg('bot', "‚ö†Ô∏è Falta o vencimento (Ex: dia 15).");
                chatState = { type: 'add', payload: { name: name, due_day: day, active: true, whatsapp: '00000000', product_id: productID } };
                addMsg('bot', `<span>Cadastrar <b>${name}</b> (Dia ${day})?</span><div class="chat-options"><button class="chat-btn chat-btn-success" onclick="sendChat('Sim')">‚úÖ Sim</button><button class="chat-btn chat-btn-danger" onclick="sendChat('N√£o')">‚ùå N√£o</button></div>`);
            }
            else { 
                // LISTA DE PALAVRAS IGNORADAS (STOP WORDS)
                const commandWords = ['pagou','recebi','exclua','apague','delete','hoje','vencimento','vence','dia','cobre','cobrar','pix','gera','gerar','tem','existe','ha','quem','busca','procura','consultar','ver','ache','encontre','status','situacao','o','a','do','da','de','em','cliente','por','para'];
                
                // CORRE√á√ÉO DO BUG: Agora usa "includes(w)" (exato) em vez de w.includes (parcial)
                // Tamb√©m removemos pontua√ß√£o antes do split
                const searchWords = lower.split(' ').filter(w => w.length > 1 && !commandWords.includes(w) && isNaN(w.replace(',','.')));
                
                let matches = []; 
                if (searchWords.length > 0) matches = allClients.filter(c => searchWords.every(word => normalizeText(c.name).includes(word)));
                
                // Se n√£o achou nada, avisa qual nome buscou
                if (matches.length === 0) return addMsg('bot', `‚ùå N√£o encontrei ningu√©m com nome parecido com "<b>${searchWords.join(' ')}</b>".`);
                
                if (matches.length > 1) { 
                    let btns = matches.map(c => `<button class="chat-btn" onclick="sendChat('${intent === 'SEARCH' ? 'Ver' : originalText.split(' ')[0]} ${c.name}')"><i class="fas fa-user"></i> ${c.name}</button>`).join(''); 
                    return addMsg('bot', `<span>üîç Achei <b>${matches.length}</b> clientes. Qual deles?</span><div class="chat-options">${btns}</div>`); 
                }
                
                const client = matches[0];

                if (intent === 'SEARCH') {
                    const now = new Date();
                    const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString();
                    const endMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString();
                    const totalPaid = historyData.filter(h => h.client_id === client.id && h.payment_date >= startMonth && h.payment_date <= endMonth && (h.status === 'approved' || !h.status)).reduce((sum, h) => sum + (Number(h.amount)||0), 0);
                    const price = client.agreed_price || client.products?.price || 0;
                    const remaining = Math.max(0, price - totalPaid);
                    const prodName = client.products?.name || 'Sem Plano';
                    const statusIcon = client.active ? 'üü¢' : 'üî¥';
                    const finStatus = remaining > 0 ? `<b class="text-yellow-400">Pendente: ${formatCurrency(remaining)}</b>` : '<b class="text-emerald-400">‚úÖ M√™s Quitado</b>';

                    const cardHtml = `
                        <div class="bg-slate-900 p-3 rounded-xl border border-slate-700 mt-1">
                            <div class="flex justify-between items-center mb-2 border-b border-slate-800 pb-2">
                                <h4 class="font-bold text-white text-sm">${client.name}</h4>
                                <span class="text-xs">${statusIcon}</span>
                            </div>
                            <div class="space-y-1 text-xs text-slate-400">
                                <p>üìÖ Vence dia: <b class="text-white">${client.due_day}</b></p>
                                <p>üì¶ Plano: <b class="text-white">${prodName}</b></p>
                                <p>üí∞ Valor: <b class="text-white">${formatCurrency(price)}</b></p>
                                <div class="mt-2 pt-2 border-t border-slate-800 text-center">${finStatus}</div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 mt-3">
                                <button onclick="sendChat('Cobrar ${client.name}')" class="chat-btn justify-center"><i class="fas fa-qrcode"></i> Cobrar</button>
                                <button onclick="editClient('${client.id}')" class="chat-btn justify-center"><i class="fas fa-edit"></i> Editar</button>
                            </div>
                        </div>
                    `;
                    return addMsg('bot', `Aqui est√° o que encontrei sobre <b>${client.name}</b>:${cardHtml}`);
                }

                if (intent === 'DEL') { chatState = { type: 'del', id: client.id, name: client.name }; addMsg('bot', `<span>‚ö†Ô∏è Excluir <b>${client.name}</b>?</span><div class="chat-options"><button class="chat-btn chat-btn-danger" onclick="sendChat('Sim')">üóëÔ∏è Excluir</button><button class="chat-btn" onclick="sendChat('N√£o')">Cancelar</button></div>`); } 
                else if (intent === 'PAY') { const amt = text.match(/(\d+([.,]\d{1,2})?)/); const val = amt ? parseFloat(amt[0].replace(',', '.')) : 0; if(!val) return addMsg('bot', "üí∞ Qual o valor pago?"); chatState = { type: 'pay', payload: { client_id: client.id, amount: val, payment_date: new Date().toISOString(), method: 'bot', status: 'approved' }, clientName: client.name }; addMsg('bot', `<span>Lan√ßar Pagamento de R$ ${val} para <b>${client.name}</b>?</span><div class="chat-options"><button class="chat-btn chat-btn-success" onclick="sendChat('Sim')">‚úÖ Sim</button><button class="chat-btn" onclick="sendChat('N√£o')">Cancelar</button></div>`); }
                else if (intent === 'CHARGE') {
                     const amt = text.match(/(\d+([.,]\d{1,2})?)/); let val = amt ? parseFloat(amt[0].replace(',', '.')) : 0;
                     if (!val) { const now = new Date(); const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).toISOString(); const endMonth = new Date(now.getFullYear(), now.getMonth()+1, 0).toISOString(); const totalPaid = historyData.filter(h => h.client_id === client.id && h.payment_date >= startMonth && h.payment_date <= endMonth && (h.status === 'approved' || !h.status)).reduce((sum, h) => sum + (Number(h.amount)||0), 0); const price = client.agreed_price || client.products?.price || 0; if (totalPaid < price && price > 0) val = price - totalPaid; }
                     if (!val) return addMsg('bot', `üí∞ O cliente parece estar quitado. Qual valor cobrar?`);
                     val = Math.round(val * 100) / 100; chatState = { type: 'gen_pix', payload: { client: client, amount: val } }; addMsg('bot', `<span>Gerar Pix de <b>R$ ${val.toFixed(2)}</b> para <b>${client.name}</b>?</span><div class="chat-options"><button class="chat-btn chat-btn-success" onclick="sendChat('Sim')">‚úÖ Gerar Pix</button><button class="chat-btn" onclick="sendChat('N√£o')">Cancelar</button></div>`);
                }
            }
        }

        function showNotification(name, amount) {
            const area = document.getElementById('notification-area');
            const toast = document.createElement('div'); toast.className = 'toast-card';
            toast.innerHTML = `<div class="bg-emerald-500 w-10 h-10 rounded-full flex items-center justify-center shrink-0"><i class="fas fa-check text-white font-bold"></i></div><div><h4 class="font-bold text-sm text-emerald-300">Pagamento Recebido!</h4><p class="text-xs text-white">${name} pagou <span class="font-mono font-bold">${amount}</span></p></div>`;
            area.appendChild(toast);
            try { new Audio('https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3').play().catch(()=>{}); } catch(e){}
            setTimeout(() => { toast.classList.add('fade-out'); setTimeout(() => toast.remove(), 500); }, 5000);
        }

        // --- SININHO INTELIGENTE (MEM√ìRIA LOCAL) ---
        function toggleNotifPanel() {
            const panel = document.getElementById('notif-panel');
            if (panel.style.display === 'flex') {
                panel.style.display = 'none';
            } else {
                renderNotifications();
                panel.style.display = 'flex';
                // Marca tudo como lido agora
                localStorage.setItem('boxpower_last_read', new Date().toISOString());
                document.getElementById('notif-badge').classList.remove('visible');
            }
        }

        function renderNotifications() {
            const list = document.getElementById('notif-list');
            const today = new Date();
            const recentPayments = historyData
                .filter(h => {
                    if (h.status !== 'approved' && (h.status || h.method === 'pix_mercadopago')) return false;
                    const pDate = new Date(h.payment_date);
                    return pDate.getDate() === today.getDate() && pDate.getMonth() === today.getMonth() && pDate.getFullYear() === today.getFullYear();
                })
                .sort((a,b) => new Date(b.payment_date).getTime() - new Date(a.payment_date).getTime());

            if (recentPayments.length === 0) { list.innerHTML = '<div class="p-6 text-center text-slate-500 text-xs">Nenhum pagamento hoje.</div>'; return; }

            list.innerHTML = recentPayments.map(pay => {
                const client = allClients.find(c => c.id === pay.client_id);
                const clientName = client ? client.name : 'Cliente Exclu√≠do';
                let prodName = 'S/ Plano'; if (client && client.product_id) { const prod = allProducts.find(p => p.id === client.product_id); if (prod) prodName = prod.name; }
                const pDate = new Date(pay.payment_date);
                return `<div class="notif-item"><div class="notif-icon"><i class="fas fa-dollar-sign"></i></div><div class="flex-1"><div class="flex justify-between items-start"><h4 class="text-xs font-bold text-white">${clientName}</h4><span class="text-[10px] font-mono text-emerald-400 font-bold">${formatCurrency(pay.amount)}</span></div><p class="text-[10px] text-slate-400 mt-0.5">${prodName}</p><div class="flex justify-between mt-1 border-t border-slate-700/50 pt-1"><span class="text-[9px] text-slate-500">Hoje √†s ${pDate.toLocaleTimeString().slice(0,5)}</span></div></div></div>`;
            }).join('');
        }

        function updateNotificationBadge() {
            const today = new Date().toISOString().slice(0, 10);
            const lastRead = localStorage.getItem('boxpower_last_read') || '2000-01-01';
            
            // Conta apenas o que √© DE HOJE e POSTERIOR √† √∫ltima leitura
            const count = historyData.filter(h => 
                h.status === 'approved' && 
                h.payment_date.startsWith(today) && 
                h.payment_date > lastRead
            ).length;
            
            const badge = document.getElementById('notif-badge');
            if (count > 0) {
                badge.innerText = count;
                badge.classList.add('visible');
            } else {
                badge.classList.remove('visible');
            }
        }
    </script>
</body>
</html>
