<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxPower V25.24 - Gest√£o Focada</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 120px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; border: 2px solid #0f172a; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        select { background-color: #0f172a; color: white; }
        select option { background-color: #1e293b; color: white; }

        .report-container { overflow-x: auto; position: relative; max-width: 100vw; border-radius: 0 0 1rem 1rem; }
        .report-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .report-table th, .report-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); white-space: nowrap; }
        .sticky-col { position: sticky; left: 0; z-index: 10; background: #1e293b; border-right: 2px solid rgba(255,255,255,0.1); min-width: 140px; max-width: 140px; text-align: left !important; font-weight: bold; }
        th.sticky-col { z-index: 20; background: #0f172a; }
        .report-table th { font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; background: #0f172a; border-bottom: 2px solid rgba(255,255,255,0.1); }
        .report-table td { font-size: 0.75rem; }

        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 9px; font-weight: bold; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #0f172a; opacity: 0; transition: opacity 0.3s; }
        .notif-badge.visible { opacity: 1; }
        #notif-panel { position: fixed; top: 70px; right: 10px; width: 300px; max-height: 350px; background: #1e293b; border: 1px solid #334155; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); z-index: 9999; display: none; flex-direction: column; overflow: hidden; animation: slideDown 0.2s ease-out; }
        .log-entry { font-family: 'Fira Code', monospace; font-size: 10px; border-left: 2px solid #475569; padding-left: 8px; margin-bottom: 8px; }
    </style>
</head>
<body>

    <div id="notification-area"></div>

    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-950 transition-opacity duration-300">
        <div class="glass p-8 rounded-3xl w-80 text-center shadow-2xl border-t border-blue-500/30">
            <div class="flex justify-center mb-6">
                <img src="https://i.ibb.co/6JP034RZ/Whats-App-Image-2026-01-30-at-18-18-51.jpg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" class="w-32 h-32 object-contain drop-shadow-2xl rounded-2xl">
            </div>
            <h1 class="text-2xl font-bold mb-2 text-white">BoxPower Hub</h1>
            <p class="text-slate-400 text-sm mb-6">Acesso Administrativo</p>
            <input type="password" id="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-4 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500 transition-all mb-4 text-white">
            <button id="btn-login" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg mt-4">ENTRAR</button>
        </div>
    </div>

    <div id="main-content" class="hidden opacity-0 transition-opacity duration-500 flex flex-col h-full">
        <header class="p-4 flex justify-between items-center bg-slate-900/90 sticky top-0 z-20 backdrop-blur-sm border-b border-slate-800 shrink-0">
            <div class="flex flex-col">
                <h2 id="header-greeting" class="text-emerald-400 text-[10px] font-bold uppercase tracking-widest">Bem-vindo</h2>
                <h1 class="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-white drop-shadow-lg leading-tight">BoxPower Hub</h1>
                <span class="text-[9px] text-slate-500 font-mono">v25.24</span>
            </div>
            <div class="flex gap-2">
                <button onclick="openLogsModal()" class="w-8 h-8 bg-slate-800 text-yellow-500 border border-slate-700 rounded-lg flex items-center justify-center hover:bg-slate-700 hover:text-white" title="Logs"><i class="fas fa-clipboard-list text-xs"></i></button>
                <button onclick="toggleNotifPanel()" class="notif-btn w-8 h-8 bg-slate-800 text-slate-400 border border-slate-700 rounded-lg flex items-center justify-center hover:bg-slate-700 hover:text-white"><i class="fas fa-bell text-xs"></i><span id="notif-badge" class="notif-badge">0</span></button>
                <button onclick="refreshApp()" class="w-8 h-8 bg-emerald-500/10 text-emerald-500 border border-emerald-500/30 rounded-lg flex items-center justify-center hover:bg-emerald-500 hover:text-white"><i id="refresh-icon" class="fas fa-sync-alt text-xs"></i></button>
                <button onclick="window.location.reload()" class="w-8 h-8 bg-red-500/10 text-red-500 border border-red-500/30 rounded-lg flex items-center justify-center hover:bg-red-500 hover:text-white"><i class="fas fa-power-off text-xs"></i></button>
            </div>
        </header>

        <div id="notif-panel"><div class="notif-header p-3 bg-slate-900 border-b border-slate-700 font-bold text-[10px] text-slate-400 flex justify-between"><span>RECEBIMENTOS HOJE</span><button onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button></div><div id="notif-list" class="notif-list bg-slate-900/50 text-xs p-2 overflow-y-auto max-h-64"></div></div>

        <div id="connection-status" class="hidden bg-yellow-500/20 text-yellow-200 text-xs text-center p-2 mb-2 mx-4 rounded-lg border border-yellow-500/50">‚è≥ Conectando...</div>
        <div id="error-alert" class="hidden bg-red-900/80 text-red-200 text-xs p-4 mb-2 mx-4 rounded-lg border border-red-500 shadow-xl font-mono break-all"></div>

        <div id="tab-home" class="tab-content active p-4 space-y-4">
            <div class="glass p-2 rounded-xl flex items-center gap-3 border border-slate-700 bg-slate-800">
                <i class="fas fa-calendar-alt text-emerald-500 ml-2"></i>
                <select id="dashboard-filter-month" onchange="calculateDashboard()" class="w-full bg-slate-800 text-sm font-bold text-white outline-none border-none focus:ring-0"></select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-4 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border-l-4 border-l-emerald-500 relative group">
                    <div class="flex justify-between items-start"><p class="text-slate-400 text-[10px] font-bold uppercase">Receita Real</p><button onclick="setMonthlyGoal()" class="text-emerald-500/50 hover:text-white transition-colors"><i class="fas fa-pencil-alt text-xs"></i></button></div>
                    <h3 id="stat-paid-amount" class="text-xl font-bold text-emerald-400">R$ 0,00</h3><p id="goal-display" class="text-[9px] text-emerald-600 font-mono hidden">Meta: R$ 0,00</p>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 mt-2 overflow-hidden"><div id="revenue-progress" class="bg-emerald-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                </div>
                <div class="glass p-4 rounded-2xl border-l-4 border-l-blue-500"><p class="text-slate-400 text-[10px] font-bold uppercase">RECEITA PREVISTA</p><h3 id="stat-projected" class="text-xl font-bold text-blue-400">R$ 0,00</h3><p class="text-[9px] text-slate-500 mt-1">Estimativa M√©dia</p></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-3 rounded-xl border border-red-500/30 bg-red-900/10">
                    <p class="text-red-400 text-[9px] uppercase font-bold"><i class="fas fa-clock mr-1"></i> Pendente (Total)</p>
                    <h4 id="stat-pending-total" class="text-lg font-bold text-white mt-1">R$ 0,00</h4>
                </div>
                <div class="glass p-3 rounded-xl border border-yellow-500/30 bg-yellow-900/10">
                    <p class="text-yellow-400 text-[9px] uppercase font-bold"><i class="fas fa-coins mr-1"></i> Lucro L√≠quido</p>
                    <h4 id="stat-profit" class="text-lg font-bold text-white mt-1">R$ 0,00</h4>
                </div>
            </div>

            <div class="glass rounded-3xl overflow-hidden border border-slate-700/50 mt-2">
                <div class="p-4 border-b border-slate-700 bg-slate-800/30"><div class="flex justify-between items-center mb-2"><h3 class="font-bold flex items-center gap-2 text-sm uppercase tracking-wider text-slate-300"><i class="fas fa-exclamation-triangle text-yellow-400 text-sm"></i> <span id="pending-header-title">PEND√äNCIAS</span></h3><span id="badge-count" class="bg-yellow-600 text-white text-sm font-bold px-2.5 py-0.5 rounded-lg shadow-lg">0</span></div><input type="text" id="search-pending" oninput="filterPendingQueue()" placeholder="Buscar devedor..." class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-1.5 text-xs text-white outline-none focus:border-blue-500"></div>
                <div id="billing-queue" class="divide-y divide-slate-800 max-h-96 overflow-y-auto bg-slate-900/30 pb-12"></div>
            </div>
        </div>

        <div id="tab-expenses" class="tab-content p-4">
            <div class="bg-slate-800 p-4 rounded-xl border border-red-500/30 mb-4 space-y-3 shadow-lg">
                <h3 class="text-xs font-bold text-red-400 uppercase">Nova Despesa</h3>
                <input type="text" id="exp-desc" placeholder="Ex: Energia, Internet..." class="w-full bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white focus:border-red-500 outline-none">
                <div class="flex gap-2">
                    <input type="text" id="exp-amount" inputmode="decimal" onblur="formatInputCurrency(this)" placeholder="R$ 0,00" class="w-1/2 bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white font-bold tracking-wide">
                    <input type="date" id="exp-date" class="w-1/2 bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white">
                </div>
                <div class="flex gap-2">
                    <select id="exp-status" class="w-full bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white font-bold">
                        <option value="pending" class="text-yellow-400">üïí Agendar (Pendente)</option>
                        <option value="paid" class="text-green-400">‚úÖ Pagar Agora</option>
                    </select>
                </div>
                <button onclick="saveExpense()" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-500 shadow-md transform active:scale-95 transition-all">SALVAR CONTA</button>
            </div>

            <div class="glass rounded-2xl overflow-hidden border border-slate-700">
                <div class="p-3 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                    <span class="text-xs text-slate-400 uppercase font-bold tracking-wider">√öltimos Lan√ßamentos</span>
                    <span id="expense-total-display" class="text-xs text-red-400 font-bold"></span>
                </div>
                <div id="expenses-list" class="divide-y divide-slate-700/50"></div>
            </div>
        </div>

        <div id="tab-clients" class="tab-content p-4 space-y-4">
            <div id="client-stats-container" class="glass p-3 rounded-xl mb-2 flex flex-col gap-2"></div>
            <div class="flex gap-2">
                <div class="relative flex-1"><i class="fas fa-search absolute left-4 top-3.5 text-slate-500"></i><input type="text" id="search-client" oninput="filterClients()" placeholder="Buscar nome ou celular..." class="w-full bg-slate-800 rounded-xl py-3 pl-11 pr-4 outline-none border border-slate-700 focus:border-blue-500 text-white"></div>
                <button id="btn-filter-inactive" onclick="toggleInactiveFilter()" class="bg-slate-800 w-12 rounded-xl text-slate-400 border border-slate-700 shadow-lg transition-colors" title="Ver Inativos"><i class="fas fa-user-slash"></i></button>
                <button onclick="openModal()" class="bg-blue-600 w-12 rounded-xl text-white shadow-lg"><i class="fas fa-plus"></i></button>
            </div>
            <div id="clients-list" class="space-y-3 pb-20"></div>
        </div>

        <div id="tab-reports" class="tab-content p-4">
            <div class="glass rounded-2xl overflow-hidden border border-slate-700">
                <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex gap-2">
                    <select id="report-filter-month" onchange="renderReportTable()" class="w-1/2 bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded-lg py-2 pl-2 outline-none"></select>
                    <select id="report-filter-product" onchange="renderReportTable()" class="w-1/2 bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded-lg py-2 pl-2 outline-none"><option value="all">Planos: Todos</option></select>
                </div>
                <div class="report-container">
                    <table class="report-table w-full">
                        <thead id="report-header">
                            </thead>
                        <tbody id="report-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-config" class="tab-content p-4"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-300">Planos</h3><button onclick="openProductModal()" class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded-lg hover:bg-emerald-500"><i class="fas fa-plus mr-1"></i> Novo</button></div><div id="products-list" class="space-y-2 pb-20"></div></div>

        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-slate-700 flex justify-around p-3 z-40 bg-slate-900/90 backdrop-blur-md">
            <button onclick="showTab('tab-home')" class="nav-item text-blue-500 flex flex-col items-center" data-tab="tab-home"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px]">In√≠cio</span></button>
            <button onclick="showTab('tab-expenses')" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-expenses"><i class="fas fa-file-invoice-dollar text-xl mb-1"></i><span class="text-[10px]">Despesas</span></button>
            <button onclick="showTab('tab-reports')" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-reports"><i class="fas fa-chart-bar text-xl mb-1"></i><span class="text-[10px]">Relat√≥rios</span></button>
            <button onclick="showTab('tab-clients')" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-clients"><i class="fas fa-users text-xl mb-1"></i><span class="text-[10px]">Clientes</span></button>
            <button onclick="showTab('tab-config')" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-config"><i class="fas fa-tags text-xl mb-1"></i><span class="text-[10px]">Planos</span></button>
        </nav>

        <div id="logs-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 p-6 shadow-2xl h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-white">Auditoria</h3><button onclick="document.getElementById('logs-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div><div id="logs-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></div></div></div>

        <div id="client-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 w-full max-w-md rounded-3xl border border-slate-700 p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                <h3 id="modal-title" class="text-xl font-bold mb-4">Cliente</h3>
                <input type="hidden" id="modal-client-id">
                <div class="space-y-3">
                    <input type="text" id="modal-name" placeholder="Nome" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white">
                    <div class="flex gap-2">
                        <input type="number" id="modal-due" placeholder="Dia Venc." class="w-1/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white">
                        <input type="text" id="modal-whatsapp" oninput="maskPhone(this)" placeholder="(DD) 9XXXX-XXXX" class="w-2/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white font-mono tracking-wider">
                    </div>
                    <div class="flex gap-2 mt-2">
                        <select id="modal-status" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none font-bold text-white">
                            <option value="true" class="text-green-400">Ativo</option>
                            <option value="false" class="text-red-400">Inativo</option>
                        </select>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-slate-700">
                    <button id="btn-show-history" onclick="toggleHistorySection()" class="w-full bg-slate-800 text-slate-300 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 border border-slate-700 transition-all flex items-center justify-center gap-2">
                        <i class="fas fa-coins text-yellow-500"></i> Gerenciar Pagamentos
                    </button>
                </div>

                <div id="history-section" class="mt-4 hidden bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-slate-400 uppercase">Pagamentos</h4><button onclick="openHistoryForm()" class="text-xs bg-slate-700 px-3 py-1.5 rounded-lg hover:bg-slate-600 border border-slate-600 transition-colors"><i class="fas fa-plus mr-1 text-blue-400"></i> Novo</button></div>
                    
                    <div id="history-form-container" class="bg-slate-800 p-3 rounded-xl border border-blue-500/30 mb-2" style="display:none;"> 
                        <input type="hidden" id="hist-id"> <div class="flex gap-2 mb-2">
                            <div class="w-1/2"><label class="text-[9px] text-slate-500 uppercase font-bold">Data</label><input type="date" id="hist-date" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white"></div>
                            <div class="w-1/2"><label class="text-[9px] text-slate-500 uppercase font-bold">Valor (R$)</label><input type="text" id="hist-amount" inputmode="decimal" onblur="formatInputCurrency(this)" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white font-bold text-emerald-400"></div>
                        </div>
                        <div class="mb-2">
                            <label class="text-[9px] text-slate-500 uppercase font-bold">Referente a qual produto?</label>
                            <select id="hist-product" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white"></select>
                        </div>
                        <div class="flex gap-2"><button onclick="closeHistoryForm()" class="flex-1 bg-slate-700 text-xs py-2 rounded text-slate-300">Cancelar</button><button onclick="saveHistory()" class="flex-1 bg-blue-600 text-xs py-2 rounded text-white font-bold">Salvar</button></div>
                    </div>
                    
                    <div id="history-list" class="bg-slate-900 rounded-xl p-2 space-y-1 max-h-40 overflow-y-auto text-xs border border-slate-800"></div>
                </div>

                <div class="flex gap-3 mt-6"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-800 text-slate-400">Cancelar</button><button onclick="saveClient()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg">Salvar Cliente</button></div>
            </div>
        </div>

        <div id="product-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 p-6 shadow-2xl"><h3 id="product-modal-title" class="text-lg font-bold mb-4">Gerenciar Plano</h3><input type="hidden" id="prod-id"><div class="space-y-3"><div><label class="text-[10px] text-slate-500 uppercase font-bold">Nome do Plano</label><input type="text" id="prod-name" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white"></div><div><label class="text-[10px] text-slate-500 uppercase font-bold">Pre√ßo (R$)</label><input type="number" id="prod-price" step="0.01" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white font-bold text-emerald-400"></div></div><div class="flex gap-3 mt-6"><button onclick="document.getElementById('product-modal').classList.add('hidden')" class="flex-1 py-2.5 rounded-xl bg-slate-800 text-slate-400">Cancelar</button><button onclick="saveProduct()" class="flex-1 py-2.5 rounded-xl bg-emerald-600 text-white font-bold">Salvar</button></div></div></div>
    </div>

    <script>
        const SUPABASE_URL = "https://epwmoicgvuprzkcpxjoy.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwd21vaWNndnVwcnprY3B4am95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDAxMjgsImV4cCI6MjA4NTMxNjEyOH0.pXcCWqGQSS6YMIZeIyfAaGlNaW6Mx2hfDQtVrX4zues";
        
        let sb = null, allClients = [], allProducts = [], historyData = [], allExpenses = [];
        let currentMonthGoal = 0, showInactiveOnly = false, currentUser = "Desconhecido";
        const USERS = { "1234": "T√∫lio", "9999": "C√≠cero" };

        // === UTILS ===
        const formatCurrency = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val || 0);
        const padId = (num) => String(num).padStart(2, '0');
        const setTxt = (id, val) => { const el = document.getElementById(id); if(el) el.innerText = val; };
        
        function formatInputCurrency(el) {
            if(!el.value) return;
            const val = parseMoneyBR(el.value);
            if(val !== 0 && !isNaN(val)) el.value = val.toFixed(2).replace('.', ',');
        }

        function parseMoneyBR(value) {
            if (!value) return 0;
            if (typeof value === 'number') return value;
            let clean = value.replace(/[^\d,-]/g, '');
            clean = clean.replace(',', '.');
            return parseFloat(clean) || 0;
        }

        // === M√ÅSCARA TELEFONE EL√ÅSTICA (SEM TRAVAMENTO) ===
        function maskPhone(el) { 
            let v = el.value.replace(/\D/g,'');
            // Removemos o limite r√≠gido de 11 aqui para permitir digita√ß√£o fluida
            
            // M√°scara Din√¢mica
            if(v.length > 10) {
                // (DD) 9XXXX-XXXX
                v = v.substring(0, 11); // Corta excesso aqui
                v = v.replace(/^(\d{2})(\d{5})(\d{4})/, '($1) $2-$3');
            } else if(v.length > 6) {
                // (DD) XXXX-XXXX (Fixo ou Celular incompleto)
                v = v.replace(/^(\d{2})(\d{4})(\d{0,4})/, '($1) $2-$3');
            } else if(v.length > 2) {
                // (DD) XXX...
                v = v.replace(/^(\d{2})(\d{0,5})/, '($1) $2');
            }
            
            el.value = v;
        }

        function toggleHistorySection() {
            const sec = document.getElementById('history-section');
            sec.classList.toggle('hidden');
        }

        function showTab(id){ 
            document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active')); 
            document.querySelectorAll('.nav-item').forEach(n=>{
                n.classList.remove('text-blue-500');
                n.classList.add('text-slate-500');
            }); 
            
            const target = document.getElementById(id);
            if(target) target.classList.add('active');
            
            const btn = document.querySelector(`button[data-tab="${id}"]`);
            if(btn) {
                btn.classList.remove('text-slate-500');
                btn.classList.add('text-blue-500');
            }
            
            if(id === 'tab-expenses') renderExpensesList(); 
            if(id === 'tab-home') calculateDashboard(); 
            if(id === 'tab-clients') filterClients();
        }

        function performLogin() {
            const btn = document.getElementById('btn-login');
            if(btn) btn.innerText = "Verificando...";
            const pin = document.getElementById('pin-input').value;
            if(USERS[pin]) {
                currentUser = USERS[pin];
                setTxt('header-greeting', `Ol√°, ${currentUser}`);
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('main-content').classList.remove('hidden');
                setTimeout(() => document.getElementById('main-content').style.opacity = "1", 50);
                initSystem();
            } else {
                alert("PIN Incorreto");
                if(btn) btn.innerText = "ENTRAR";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            const btn = document.getElementById('btn-login');
            if(btn) btn.addEventListener('click', performLogin);
            const input = document.getElementById('pin-input');
            if(input) input.addEventListener('keypress', (e) => { if(e.key === 'Enter') performLogin(); });
        });

        function initSystem() {
            if(window.supabase) {
                sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                document.getElementById('connection-status').classList.add('hidden');
                loadAllData();
                ['payment_history', 'expenses', 'clients', 'products'].forEach(t => {
                    sb.channel(t).on('postgres_changes',{ event: '*', schema: 'public', table: t },() => refreshApp()).subscribe();
                });
            }
        }

        async function refreshApp() {
            const i = document.getElementById('refresh-icon'); if(i) i.classList.add('fa-spin');
            await loadAllData();
            if(i) setTimeout(() => i.classList.remove('fa-spin'), 1000);
        }

        async function loadAllData() {
            try {
                await Promise.all([fetchProducts(), fetchClients(), fetchFullHistory(), fetchExpenses()]);
                document.getElementById('error-alert').classList.add('hidden');
                populateMonthFilter();
                calculateDashboard();
                renderReportTable();
                updateClientStatsUI();
                renderExpensesList();
            } catch (e) { 
                console.error(e);
                const errDiv = document.getElementById('error-alert');
                if(errDiv) { errDiv.innerText = `‚ö†Ô∏è Erro parcial: ${e.message}`; errDiv.classList.remove('hidden'); }
            }
        }

        async function fetchProducts() {
            if(!sb) return;
            const { data } = await sb.from('products').select('*').order('name');
            allProducts = data || [];
            updateProductUI();
        }

        async function fetchClients() {
            if(!sb) return;
            let { data, error } = await sb.from('clients').select('*').order('name');
            if(error) { console.warn(error); allClients = []; return; }
            allClients = data || [];
            renderClients(allClients);
            updateClientStatsUI();
        }

        async function fetchFullHistory() {
            if(!sb) return;
            const { data } = await sb.from('payment_history').select('*');
            historyData = data || [];
        }

        async function fetchExpenses() {
            if(!sb) return;
            const { data } = await sb.from('expenses').select('*').order('date', {ascending: false});
            allExpenses = data || [];
        }

        function updateClientStatsUI() {
            const el = document.getElementById('client-stats-container');
            if(!el) return;
            const total = allClients.length;
            const active = allClients.filter(c => c.active).length;
            
            setTxt('stat-total-clients', total);
            setTxt('stat-active-clients', active);
            setTxt('stat-inactive-clients', total - active);

            const planCounts = {};
            // L√≥gica ajustada para contar pagamentos recentes como "ativos" se necess√°rio, 
            // mas aqui mantemos o cadastro ativo/inativo como base.
            // Para "Sem Plano", podemos listar quem n√£o tem pagamentos recentes se quiser.
            // Por enquanto, mantendo simples:
            el.innerHTML = ''; // Limpa pois removemos a complexidade de planos no cadastro
        }

        async function calculateDashboard() {
            const el = document.getElementById('dashboard-filter-month');
            if(!el) return;
            const v = el.value;
            let t = new Date(); 
            if(v) { const [y, m] = v.split('-'); t = new Date(parseInt(y), parseInt(m)-1, 1); }
            
            const startStr = new Date(t.getFullYear(), t.getMonth(), 1).toISOString();
            const endStr = new Date(t.getFullYear(), t.getMonth()+1, 0, 23, 59, 59).toISOString();
            const monthKey = v || t.toISOString().slice(0, 7);

            try { const { data } = await sb.from('monthly_goals').select('target_amount').eq('month', monthKey).single(); currentMonthGoal = data ? Number(data.target_amount) : 0; } catch(e) { currentMonthGoal = 0; }
            const gEl = document.getElementById('goal-display');
            if(gEl) { gEl.innerText = `Meta: ${formatCurrency(currentMonthGoal)}`; gEl.classList.remove(currentMonthGoal > 0 ? 'hidden' : 'flex'); if(currentMonthGoal===0) gEl.classList.add('hidden'); }

            const receita = historyData.filter(h => h.payment_date >= startStr && h.payment_date <= endStr && (h.status === 'approved' || !h.status)).reduce((a,c) => a + (Number(c.amount)||0), 0);
            
            // Estimativa M√©dia (Baseada na m√©dia de pagamentos dos clientes ativos)
            const mediaPagamento = receita > 0 ? receita / (historyData.filter(h => h.payment_date >= startStr && h.payment_date <= endStr).length || 1) : 0;
            const projecao = allClients.filter(c => c.active).length * mediaPagamento;

            const despesas = allExpenses.filter(e => e.date >= startStr.slice(0,10) && e.date <= endStr.slice(0,10));
            const pagas = despesas.filter(e => e.status === 'paid').reduce((a,c) => a + (Number(c.amount)||0), 0);

            setTxt('stat-paid-amount', formatCurrency(receita));
            setTxt('stat-projected', formatCurrency(projecao));
            setTxt('stat-profit', formatCurrency(receita - pagas));
            
            const prog = document.getElementById('revenue-progress');
            if(prog) {
                const target = currentMonthGoal > 0 ? currentMonthGoal : projecao;
                prog.style.width = target > 0 ? `${Math.min((receita/target)*100, 100)}%` : '0%';
            }

            const now = new Date();
            
            // Pendentes: Clientes ativos que N√ÉO pagaram neste m√™s
            const pendingList = allClients.filter(c => {
                if(!c.active) return false;
                const paid = historyData.some(h => h.client_id === c.id && h.payment_date >= startStr && h.payment_date <= endStr && (h.status==='approved' || !h.status));
                return !paid;
            });

            // Valor Pendente Total (Estimado pela m√©dia ou zero se n√£o tiver base)
            // Como n√£o temos valor fixo no cadastro, usamos 0 ou uma m√©dia global para representar "pend√™ncia" visualmente
            const pendingMonthValue = 0; // Ajuste conforme necessidade de neg√≥cio

            setTxt('stat-pending-total', pendingList.length + " Clientes");
            setTxt('pending-header-title', `PENDENTES (${pendingList.length})`);
            setTxt('badge-count', pendingList.length);
            
            const pList = document.getElementById('billing-queue');
            if(pList) {
                const term = document.getElementById('search-pending').value.toLowerCase();
                const filtered = pendingList.filter(c => c.name.toLowerCase().includes(term));
                if(filtered.length === 0) pList.innerHTML = '<div class="p-8 text-center text-slate-500">Tudo em dia!</div>';
                else pList.innerHTML = filtered.map(c => `
                    <div class="p-3 flex justify-between items-center hover:bg-slate-800 transition border-b border-slate-800/50">
                        <div><h4 class="font-bold text-sm text-white">${c.name}</h4><p class="text-[10px] text-slate-400">Vence dia <span class="text-yellow-500">${c.due_day}</span></p></div>
                        <div class="flex gap-2">
                            <button onclick="editClient('${c.id}')" class="bg-slate-700 text-blue-400 w-8 h-8 rounded-lg"><i class="fas fa-pen text-xs"></i></button>
                            <a href="https://api.whatsapp.com/send?phone=${c.whatsapp}" target="_blank" class="bg-emerald-600 text-white w-8 h-8 rounded-lg flex items-center justify-center"><i class="fab fa-whatsapp"></i></a>
                        </div>
                    </div>`).join('');
            }
        }

        function filterPendingQueue() { calculateDashboard(); }

        // === EDI√á√ÉO DE PAGAMENTO (NOVA L√ìGICA) ===
        function openHistoryForm(payId = null) {
            const form = document.getElementById('history-form-container');
            const dateEl = document.getElementById('hist-date');
            const amountEl = document.getElementById('hist-amount');
            const prodEl = document.getElementById('hist-product');
            const idEl = document.getElementById('hist-id');

            form.style.display = 'block';
            
            // Popula Select
            prodEl.innerHTML = '<option value="">-- Selecione um Plano --</option>';
            allProducts.forEach(p => {
                const opt = document.createElement('option');
                opt.value = p.id;
                opt.text = p.name;
                prodEl.appendChild(opt);
            });

            if (payId) {
                // MODO EDI√á√ÉO
                const pay = historyData.find(h => h.id === payId);
                if (pay) {
                    idEl.value = pay.id;
                    dateEl.value = pay.payment_date.slice(0, 10);
                    amountEl.value = formatCurrency(pay.amount).replace('R$', '').trim();
                    prodEl.value = pay.product_id || '';
                }
            } else {
                // MODO NOVO
                idEl.value = '';
                dateEl.value = new Date().toISOString().slice(0, 10);
                amountEl.value = '';
                prodEl.value = '';
            }
        }

        function closeHistoryForm() { document.getElementById('history-form-container').style.display = 'none'; }

        async function saveHistory() {
            const hid = document.getElementById('hist-id').value;
            const cid = document.getElementById('modal-client-id').value;
            const rawVal = document.getElementById('hist-amount').value;
            const date = document.getElementById('hist-date').value;
            const pid = document.getElementById('hist-product').value || null;
            
            const amount = parseMoneyBR(rawVal); 

            if(!amount || !date) return alert("Preencha data e valor v√°lido.");

            const payload = {
                client_id: cid, 
                amount: amount, 
                payment_date: date + 'T12:00:00Z', 
                status: 'approved', 
                method: 'manual',
                product_id: pid 
            };

            if (hid) {
                // ATUALIZAR
                await sb.from('payment_history').update(payload).eq('id', hid);
            } else {
                // INSERIR
                await sb.from('payment_history').insert([payload]);
            }
            
            logAction(hid ? 'Editar Pagamento' : 'Novo Pagamento', `Cliente ${cid} - ${formatCurrency(amount)}`);
            
            closeHistoryForm();
            await fetchFullHistory();
            renderHistoryList(cid);
            calculateDashboard();
        }

        function renderHistoryList(cid) {
            const list = document.getElementById('history-list');
            if(!list) return;
            list.innerHTML = '';
            
            const h = historyData.filter(x => x.client_id === cid).sort((a,b)=>new Date(b.payment_date)-new Date(a.payment_date));
            
            if(h.length === 0) {
                list.innerHTML = '<p class="text-center text-slate-500 py-2">Sem hist√≥rico</p>';
                return;
            }

            list.innerHTML = h.map(i => {
                let prodLabel = '';
                if(i.product_id) {
                    const p = allProducts.find(prod => prod.id === i.product_id);
                    if(p) prodLabel = `<span class="block text-[9px] text-blue-300 font-bold">${p.name}</span>`;
                }

                return `
                <div class="flex justify-between items-center border-b border-slate-700/50 p-2 text-xs bg-slate-800/30 rounded mb-1">
                    <div>
                        <span class="text-slate-400 font-mono text-[10px]">${new Date(i.payment_date).toLocaleDateString('pt-BR')}</span>
                        ${prodLabel}
                    </div>
                    <div class="text-right flex gap-3 items-center">
                        <span class="text-emerald-400 font-bold block">${formatCurrency(i.amount)}</span> 
                        <button onclick="openHistoryForm('${i.id}')" class="text-blue-400 hover:text-white" title="Editar"><i class="fas fa-pencil-alt"></i></button>
                        <button onclick="deleteHistory('${i.id}','${cid}')" class="text-red-400 hover:text-white" title="Excluir"><i class="fas fa-trash"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        async function deleteHistory(hid, cid) {
            if(confirm("Apagar pagamento?")) {
                await sb.from('payment_history').delete().eq('id', hid);
                await fetchFullHistory();
                renderHistoryList(cid);
                calculateDashboard();
            }
        }

        async function logAction(action, details) {
            if(!sb) return;
            try { await sb.from('system_logs').insert({ user_name: currentUser, action_type: action, details: details, created_at: new Date().toISOString() }); } catch(e) { console.warn("Log falhou", e); }
        }

        async function openLogsModal() {
            const el = document.getElementById('logs-modal'); if(el) el.classList.remove('hidden');
            const list = document.getElementById('logs-list'); if(!list) return;
            list.innerHTML = '<p class="text-center text-slate-500 text-xs">Carregando...</p>';
            try {
                const date30DaysAgo = new Date(); date30DaysAgo.setDate(date30DaysAgo.getDate() - 30);
                const { data, error } = await sb.from('system_logs').select('*').gte('created_at', date30DaysAgo.toISOString()).order('created_at', { ascending: false });
                if(error) throw error;
                if(!data || data.length === 0) { list.innerHTML = '<p class="text-center text-slate-500 text-xs">Nenhum registro.</p>'; return; }
                list.innerHTML = data.map(l => `<div class="log-entry"><span class="log-user">${l.user_name}</span> <span class="log-action">${l.action_type}</span><br><span class="text-white">${l.details}</span><br><span class="log-date">${new Date(l.created_at).toLocaleString('pt-BR')}</span></div>`).join('');
            } catch (e) { list.innerHTML = `<p class="text-center text-red-400 text-xs">Erro ao carregar logs.</p>`; }
        }

        function openModal() { 
            ['modal-client-id','modal-name','modal-due','modal-whatsapp'].forEach(id=>document.getElementById(id).value='');
            document.getElementById('history-section').classList.add('hidden'); 
            document.getElementById('client-modal').classList.remove('hidden'); 
        }
        function closeModal() { document.getElementById('client-modal').classList.add('hidden'); }
        
        async function editClient(id) {
            const c = allClients.find(x => x.id === id);
            if(!c) return;
            document.getElementById('modal-client-id').value = c.id;
            document.getElementById('modal-name').value = c.name;
            document.getElementById('modal-due').value = c.due_day;
            
            // M√°scara ao carregar
            const wppInput = document.getElementById('modal-whatsapp');
            wppInput.value = c.whatsapp || '';
            maskPhone(wppInput); 

            document.getElementById('modal-status').value = c.active;
            
            document.getElementById('history-section').classList.add('hidden');
            renderHistoryList(id);
            document.getElementById('client-modal').classList.remove('hidden');
        }

        async function saveClient() {
            const id = document.getElementById('modal-client-id').value;
            const name = document.getElementById('modal-name').value;
            const due = parseInt(document.getElementById('modal-due').value)||10;
            const wpp = document.getElementById('modal-whatsapp').value;
            const active = document.getElementById('modal-status').value === 'true';

            // DADOS LIMPOS - SEM PRODUTOS FIXOS
            const d = { name, due_day: due, whatsapp: wpp, active };
            
            if(id) await sb.from('clients').update(d).eq('id', id);
            else await sb.from('clients').insert([d]);
            
            closeModal();
            loadAllData();
        }

        async function deleteClient(id, name) {
            if(confirm(`Excluir ${name}?`)) {
                await sb.from('payment_history').delete().eq('client_id', id);
                await sb.from('clients').delete().eq('id', id);
                loadAllData();
            }
        }

        function renderClients(lista) {
            const el = document.getElementById('clients-list');
            if(!el) return;
            const term = document.getElementById('search-client').value.toLowerCase();
            const termClean = term.replace(/\D/g, ''); 

            const filtered = lista.filter(c => {
                const matchName = c.name.toLowerCase().includes(term);
                const phoneClean = (c.whatsapp || '').replace(/\D/g, '');
                const matchPhone = termClean.length > 2 && phoneClean.includes(termClean); 

                if(!matchName && !matchPhone) return false;
                
                if(showInactiveOnly && c.active) return false;
                if(!showInactiveOnly && !c.active) return false;
                return true;
            });

            if(filtered.length===0) el.innerHTML = '<p class="text-center text-slate-500 text-xs mt-4">Nada encontrado.</p>';
            else el.innerHTML = filtered.map(c => {
                // Formata√ß√£o na lista principal
                let phoneDisplay = c.whatsapp || '';
                // Aplica m√°scara visual
                let v = phoneDisplay.replace(/\D/g,'');
                if(v.length > 10) v = v.replace(/^(\d{2})(\d{5})(\d{4}).*/, '($1) $2-$3');
                else if(v.length > 6) v = v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/, '($1) $2-$3');
                phoneDisplay = v;

                return `
                <div class="glass p-4 rounded-xl flex justify-between items-center border-l-4 ${c.active ? 'border-l-emerald-500' : 'border-l-red-500'}">
                    <div onclick="editClient('${c.id}')" class="flex-1 cursor-pointer">
                        <h4 class="font-bold text-sm text-white tracking-wide">${c.name}</h4>
                        <div class="text-[10px] text-slate-400 mt-1">
                            Dia ${c.due_day} - ${phoneDisplay}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="deleteClient('${c.id}', '${c.name}')" class="w-8 h-8 rounded flex items-center justify-center text-slate-500 hover:text-red-400"><i class="fas fa-trash text-xs"></i></button>
                        <button onclick="editClient('${c.id}')" class="bg-slate-800 w-8 h-8 rounded flex items-center justify-center text-blue-400"><i class="fas fa-pen text-xs"></i></button>
                    </div>
                </div>`;
            }).join('');
        }

        function filterClients() {
            renderClients(allClients);
        }

        function renderExpensesList() {
            const l = document.getElementById('expenses-list'); if(!l) return;
            const show = allExpenses.slice(0, 50);
            if(show.length===0) l.innerHTML='<p class="text-center text-xs text-slate-500 p-4">Sem despesas.</p>';
            else l.innerHTML = show.map(e => `
                <div class="flex justify-between items-center p-3 hover:bg-slate-800/30 transition-all ${e.status==='paid'?'opacity-60':''}">
                    <div class="flex items-center gap-3 cursor-pointer" onclick="toggleExpenseStatus('${e.id}','${e.status}')">
                        <div class="text-lg">${e.status==='paid'?'‚úÖ':'üïí'}</div>
                        <div><span class="text-white text-xs font-bold block ${e.status==='paid'?'line-through':''}">${e.description}</span><span class="text-slate-500 text-[9px]">${new Date(e.date).toLocaleDateString('pt-BR')}</span></div>
                    </div>
                    <div class="flex items-center gap-3"><span class="text-xs font-bold ${e.status==='paid'?'text-slate-500':'text-red-400'}">-${formatCurrency(e.amount)}</span><button onclick="deleteExpense('${e.id}')" class="text-slate-600 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div>
                </div>`).join('');
        }
        async function saveExpense() {
            const desc = document.getElementById('exp-desc').value;
            const amVal = document.getElementById('exp-amount').value;
            const date = document.getElementById('exp-date').value;
            const st = document.getElementById('exp-status').value;
            const amount = parseMoneyBR(amVal);
            if(!desc || !amount) return alert('Preencha os dados.');
            await sb.from('expenses').insert([{description:desc, amount, date, status:st}]);
            document.getElementById('exp-desc').value=''; document.getElementById('exp-amount').value='';
            loadAllData();
        }
        async function toggleExpenseStatus(id, st) { await sb.from('expenses').update({status: st==='paid'?'pending':'paid'}).eq('id',id); loadAllData(); }
        async function deleteExpense(id) { if(confirm('Apagar despesa?')) { await sb.from('expenses').delete().eq('id',id); loadAllData(); } }

        function renderReportTable() {
            const m = document.getElementById('report-filter-month'); if(!m) return;
            const v = m.value;
            if(!v) return;
            const [y, mo] = v.split('-'); 
            const dStart = new Date(y, mo-1, 1).toISOString(); 
            const dEnd = new Date(y, mo, 0, 23, 59, 59).toISOString();
            const pid = document.getElementById('report-filter-product').value;
            
            const list = allClients.filter(c => {
                if(!c.active) return false;
                // Como n√£o temos mais produto fixo no cliente, o filtro por produto
                // agora deve olhar se o cliente tem PAGAMENTO daquele produto neste m√™s
                if(pid !== 'all') {
                    const hasPayment = historyData.some(h => h.client_id === c.id && h.product_id === pid && h.payment_date >= dStart && h.payment_date <= dEnd);
                    if(!hasPayment) return false;
                }
                return true;
            });

            list.sort((a,b) => a.name.localeCompare(b.name));

            // TOTAL ARRECADADO
            const totalArrecadado = list.reduce((acc, c) => {
                const p = historyData.filter(h => h.client_id === c.id && h.payment_date >= dStart && h.payment_date <= dEnd && (h.status==='approved'||!h.status)).reduce((a,b)=>a+(Number(b.amount)||0),0);
                return acc + p;
            }, 0);

            const mesNome = new Date(dStart).toLocaleDateString('pt-BR', { month: 'short' }).toUpperCase().replace('.', '');

            // CABE√áALHO POWER
            document.getElementById('report-header').innerHTML = `
                <tr>
                    <th class="sticky-col text-left text-white bg-slate-900 border-r border-slate-700">CLIENTES (${list.length})</th>
                    <th colspan="2" class="text-emerald-400 bg-slate-900 border-l border-slate-700 font-bold tracking-widest text-[10px] text-center">${mesNome} | ${formatCurrency(totalArrecadado)}</th>
                </tr>
                <tr>
                    <th class="sticky-col bg-slate-900 border-r border-slate-700"></th>
                    <th class="sub-header text-blue-300 border-l border-slate-700 text-[9px] uppercase">DATA PAGTO</th>
                    <th class="sub-header text-emerald-300 border-l border-slate-800 text-[9px] uppercase">VALOR PAGO</th>
                </tr>`;

            const body = document.getElementById('report-body');
            body.innerHTML = list.length===0 ? '<tr><td colspan="3" class="text-center p-4 text-xs text-slate-500">Nada encontrado.</td></tr>' : list.map(c => {
                const pagamentos = historyData.filter(h => h.client_id === c.id && h.payment_date >= dStart && h.payment_date <= dEnd && (h.status==='approved'||!h.status));
                const totalPago = pagamentos.reduce((a,b)=>a+(Number(b.amount)||0),0);
                
                let diaPagamento = '-';
                if(pagamentos.length > 0) {
                    const ultimoPag = new Date(pagamentos[pagamentos.length-1].payment_date);
                    diaPagamento = `${ultimoPag.getDate()}`;
                }

                const dueDayLabel = `<span class="bg-slate-700 px-1 rounded mr-1 text-[9px] text-slate-300">${c.due_day||'?'}</span>`;
                const colCliente = `<td class="sticky-col text-xs text-left p-2 border-b border-slate-800 text-white truncate max-w-[160px]" onclick="editClient('${c.id}')">${dueDayLabel} ${c.name}</td>`;
                
                // COLUNA DATA PAGTO (CENTRAL)
                const colData = `<td class="text-center text-xs p-2 border-b border-slate-800 text-slate-500 font-mono">${diaPagamento}</td>`;
                
                // COLUNA VALOR PAGO (DIREITA)
                let colPagoClass = "text-slate-600 text-[9px]";
                let colPagoContent = "-";
                
                if(totalPago > 0) {
                    colPagoClass = "text-emerald-400 font-bold bg-emerald-500/10 text-[9px]";
                    colPagoContent = formatCurrency(totalPago);
                }

                const colPago = `<td class="text-center p-2 border-b border-slate-800 ${colPagoClass}">${colPagoContent}</td>`;

                return `<tr>${colCliente}${colData}${colPago}</tr>`;
            }).join('');
        }

        function updateProductUI() {
            const list = document.getElementById('products-list');
            if(list) list.innerHTML = allProducts.map(p => `<div class="glass p-3 rounded-xl flex justify-between items-center"><div><span class="block text-sm font-bold text-white">${p.name}</span><span class="text-xs text-emerald-400 font-mono">${formatCurrency(p.price)}</span></div><button onclick="deleteProduct('${p.id}', '${p.name}')" class="text-slate-500 hover:text-red-400"><i class="fas fa-trash text-xs"></i></button></div>`).join('');
            
            const rep = document.getElementById('report-filter-product');
            if(rep) rep.innerHTML = '<option value="all">Todos</option>' + allProducts.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');
        }
        function openProductModal() { document.getElementById('product-modal').classList.remove('hidden'); }
        async function saveProduct() {
            const n = document.getElementById('prod-name').value; const p = document.getElementById('prod-price').value;
            if(n && p) { await sb.from('products').insert([{name:n, price:p}]); document.getElementById('product-modal').classList.add('hidden'); fetchProducts(); }
        }
        async function deleteProduct(id, n) { if(confirm('Apagar plano '+n+'?')) { await sb.from('products').delete().eq('id', id); fetchProducts(); } }
        function populateMonthFilter() {
            const el = document.getElementById('dashboard-filter-month'); 
            const rep = document.getElementById('report-filter-month');
            if(el.options.length > 0) return;
            let h = '';
            for(let i=-6; i<=6; i++) {
                const d = new Date(); d.setMonth(d.getMonth() + i);
                const v = d.toISOString().slice(0,7);
                const l = d.toLocaleDateString('pt-BR', {month:'long', year:'numeric'});
                h += `<option value="${v}" ${i===0?'selected':''}>${l}</option>`;
            }
            el.innerHTML = h; rep.innerHTML = h;
        }
        function toggleInactiveFilter() { showInactiveOnly = !showInactiveOnly; renderClients(allClients); }
        function toggleNotifPanel() { const p=document.getElementById('notif-panel'); p.style.display = p.style.display==='flex'?'none':'flex'; }
        
        async function setMonthlyGoal() {
            const m = document.getElementById('dashboard-filter-month').value;
            const v = prompt("Nova meta para "+m, currentMonthGoal);
            if(v) { await sb.from('monthly_goals').upsert({month: m, target_amount: parseMoneyBR(v)}); calculateDashboard(); }
        }
    </script>
</body>
</html>
