<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>BoxPower Hub V25.34 - Select Corrigido</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;900&display=swap');
        @import url('https://fonts.googleapis.com/css2?family=Fira+Code:wght@400&display=swap');

        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f1f5f9; height: 100dvh; overflow: hidden; display: flex; flex-direction: column; }
        .glass { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.1); }
        .tab-content { display: none; height: 100%; overflow-y: auto; padding-bottom: 120px; }
        .tab-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background-color: #334155; border-radius: 4px; border: 2px solid #0f172a; }
        input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }
        
        select { background-color: #1e293b; color: white; border: 1px solid #334155; }
        select option { background-color: #1e293b; color: white; }

        .report-container { overflow-x: auto; position: relative; max-width: 100vw; border-radius: 0 0 1rem 1rem; }
        .report-table { border-collapse: separate; border-spacing: 0; width: 100%; }
        .report-table th, .report-table td { padding: 10px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); white-space: nowrap; }
        .sticky-col { position: sticky; left: 0; z-index: 10; background: #1e293b; border-right: 2px solid rgba(255,255,255,0.1); min-width: 140px; max-width: 140px; text-align: left !important; font-weight: bold; }
        th.sticky-col { z-index: 20; background: #0f172a; }
        .report-table th { font-size: 0.7rem; text-transform: uppercase; color: #94a3b8; background: #0f172a; border-bottom: 2px solid rgba(255,255,255,0.1); }
        .report-table td { font-size: 0.75rem; }
        
        #notification-area { position: fixed; top: 20px; right: 20px; z-index: 100; display: flex; flex-direction: column; gap: 10px; pointer-events: none; }
        .notif-badge { position: absolute; top: -5px; right: -5px; background: #ef4444; color: white; font-size: 9px; font-weight: bold; width: 16px; height: 16px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #0f172a; opacity: 0; transition: opacity 0.3s; }
        .notif-badge.visible { opacity: 1; }
        #notif-panel { position: fixed; top: 70px; right: 10px; width: 300px; max-height: 350px; background: #1e293b; border: 1px solid #334155; border-radius: 16px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.7); z-index: 9999; display: none; flex-direction: column; overflow: hidden; animation: slideDown 0.2s ease-out; }
        .log-entry { font-family: 'Fira Code', monospace; font-size: 10px; border-left: 2px solid #475569; padding-left: 8px; margin-bottom: 8px; }
        
        .admin-only { display: inherit; } 
    </style>
</head>
<body>

    <div id="notification-area"></div>

    <div id="login-screen" class="fixed inset-0 z-[60] flex items-center justify-center bg-slate-950 transition-opacity duration-300">
        <div class="glass p-8 rounded-3xl w-80 text-center shadow-2xl border-t border-blue-500/30">
            <div class="flex justify-center mb-6"><img src="https://i.ibb.co/6JP034RZ/Whats-App-Image-2026-01-30-at-18-18-51.jpg" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3135/3135715.png'" class="w-32 h-32 object-contain drop-shadow-2xl rounded-2xl"></div>
            <h1 class="text-2xl font-bold mb-2 text-white">BoxPower Hub</h1>
            <p class="text-slate-400 text-sm mb-6">Acesso Administrativo</p>
            <input type="password" id="pin-input" maxlength="4" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" class="w-full bg-slate-800 border border-slate-700 rounded-xl py-4 text-center text-2xl tracking-widest focus:outline-none focus:border-blue-500 transition-all mb-4 text-white">
            <button id="btn-login" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-xl transition-all shadow-lg mt-4">ENTRAR</button>
        </div>
    </div>

    <div id="main-content" class="hidden opacity-0 transition-opacity duration-500 flex flex-col h-full">
        <header class="p-4 flex justify-between items-center bg-slate-900/90 sticky top-0 z-20 backdrop-blur-sm border-b border-slate-800 shrink-0">
            <div class="flex flex-col">
                <h2 id="header-greeting" class="text-emerald-400 text-[10px] font-bold uppercase tracking-widest">Bem-vindo</h2>
                <h1 class="text-2xl font-black tracking-tighter text-transparent bg-clip-text bg-gradient-to-r from-emerald-400 to-white drop-shadow-lg leading-tight">BoxPower Hub</h1>
                <span class="text-[9px] text-slate-500 font-mono">v25.34</span>
            </div>
            <div class="flex gap-2">
                <button onclick="openLogsModal()" class="w-8 h-8 bg-slate-800 text-yellow-500 border border-slate-700 rounded-lg flex items-center justify-center hover:bg-slate-700 hover:text-white" title="Logs"><i class="fas fa-clipboard-list text-xs"></i></button>
                <button onclick="toggleNotifPanel()" class="notif-btn w-8 h-8 bg-slate-800 text-slate-400 border border-slate-700 rounded-lg flex items-center justify-center hover:bg-slate-700 hover:text-white"><i class="fas fa-bell text-xs"></i><span id="notif-badge" class="notif-badge">0</span></button>
                <button onclick="refreshApp()" class="w-8 h-8 bg-emerald-500/10 text-emerald-500 border border-emerald-500/30 rounded-lg flex items-center justify-center hover:bg-emerald-500 hover:text-white"><i id="refresh-icon" class="fas fa-sync-alt text-xs"></i></button>
                <button onclick="window.location.reload()" class="w-8 h-8 bg-red-500/10 text-red-500 border border-red-500/30 rounded-lg flex items-center justify-center hover:bg-red-500 hover:text-white"><i class="fas fa-power-off text-xs"></i></button>
            </div>
        </header>

        <div id="notif-panel"><div class="notif-header p-3 bg-slate-900 border-b border-slate-700 font-bold text-[10px] text-slate-400 flex justify-between"><span>RECEBIMENTOS HOJE</span><button onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button></div><div id="notif-list" class="notif-list bg-slate-900/50 text-xs p-2 overflow-y-auto max-h-64"></div></div>

        <div id="connection-status" class="hidden bg-yellow-500/20 text-yellow-200 text-xs text-center p-2 mb-2 mx-4 rounded-lg border border-yellow-500/50">‚è≥ Conectando...</div>
        <div id="error-alert" class="hidden bg-red-900/80 text-red-200 text-xs p-4 mb-2 mx-4 rounded-lg border border-red-500 shadow-xl font-mono break-all"></div>

        <div id="tab-home" class="tab-content active p-4 space-y-4">
            <div class="glass p-2 rounded-xl flex items-center gap-3 border border-slate-700 bg-slate-800">
                <i class="fas fa-calendar-alt text-emerald-500 ml-2"></i>
                <select id="dashboard-filter-month" onchange="calculateDashboard()" class="w-full bg-slate-800 text-sm font-bold text-white outline-none border-none focus:ring-0 cursor-pointer"></select>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-4 rounded-2xl bg-gradient-to-br from-slate-800 to-slate-900 border-l-4 border-l-emerald-500 relative group">
                    <div class="flex justify-between items-start"><p class="text-slate-400 text-[10px] font-bold uppercase">Receita Real</p><button onclick="setMonthlyGoal()" class="text-emerald-500/50 hover:text-white transition-colors"><i class="fas fa-pencil-alt text-xs"></i></button></div>
                    <h3 id="stat-paid-amount" class="text-xl font-bold text-emerald-400">R$ 0,00</h3><p id="goal-display" class="text-[9px] text-emerald-600 font-mono hidden">Meta: R$ 0,00</p>
                    <div class="w-full bg-slate-700 rounded-full h-1.5 mt-2 overflow-hidden"><div id="revenue-progress" class="bg-emerald-500 h-1.5 rounded-full transition-all duration-1000" style="width: 0%"></div></div>
                </div>
                <div class="glass p-4 rounded-2xl border-l-4 border-l-blue-500"><p class="text-slate-400 text-[10px] font-bold uppercase">RECEITA PREVISTA</p><h3 id="stat-projected" class="text-xl font-bold text-blue-400">R$ 0,00</h3><p class="text-[9px] text-slate-500 mt-1">Estimativa</p></div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="glass p-3 rounded-xl border border-red-500/30 bg-red-900/10">
                    <p class="text-red-400 text-[9px] uppercase font-bold"><i class="fas fa-clock mr-1"></i> Pendente (Total)</p>
                    <h4 id="stat-pending-total" class="text-lg font-bold text-white mt-1">R$ 0,00</h4>
                </div>
                <div class="glass p-3 rounded-xl border border-yellow-500/30 bg-yellow-900/10">
                    <p class="text-yellow-400 text-[9px] uppercase font-bold"><i class="fas fa-coins mr-1"></i> Lucro L√≠quido</p>
                    <h4 id="stat-profit" class="text-lg font-bold text-white mt-1">R$ 0,00</h4>
                </div>
            </div>

            <div class="glass rounded-3xl overflow-hidden border border-slate-700/50 mt-2">
                <div class="p-4 border-b border-slate-700 bg-slate-800/30"><div class="flex justify-between items-center mb-2"><h3 class="font-bold flex items-center gap-2 text-sm uppercase tracking-wider text-slate-300"><i class="fas fa-exclamation-triangle text-yellow-400 text-sm"></i> <span id="pending-header-title">PEND√äNCIAS</span></h3><span id="badge-count" class="bg-yellow-600 text-white text-sm font-bold px-2.5 py-0.5 rounded-lg shadow-lg">0</span></div><input type="text" id="search-pending" oninput="filterPendingQueue()" placeholder="Buscar devedor..." class="w-full bg-slate-900 border border-slate-600 rounded-lg px-3 py-1.5 text-xs text-white outline-none focus:border-blue-500"></div>
                <div id="billing-queue" class="divide-y divide-slate-800 max-h-96 overflow-y-auto bg-slate-900/30 pb-12"></div>
            </div>
        </div>

        <div id="tab-expenses" class="tab-content p-4">
            <div class="bg-slate-800 p-4 rounded-xl border border-red-500/30 mb-4 space-y-3 shadow-lg">
                <h3 class="text-xs font-bold text-red-400 uppercase">Nova Despesa</h3>
                <input type="text" id="exp-desc" placeholder="Ex: Energia, Internet..." class="w-full bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white focus:border-red-500 outline-none">
                <div class="flex gap-2">
                    <input type="text" id="exp-amount" inputmode="decimal" onblur="formatInputCurrency(this)" placeholder="R$ 0,00" class="w-1/2 bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white font-bold tracking-wide">
                    <input type="date" id="exp-date" class="w-1/2 bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white">
                </div>
                <div class="flex gap-2">
                    <select id="exp-status" class="w-full bg-slate-900 rounded-lg p-3 text-sm border border-slate-700 text-white font-bold">
                        <option value="pending" class="text-yellow-400">üïí Agendar (Pendente)</option>
                        <option value="paid" class="text-green-400">‚úÖ Pagar Agora</option>
                    </select>
                </div>
                <button onclick="saveExpense()" class="w-full bg-red-600 text-white font-bold py-3 rounded-lg hover:bg-red-500 shadow-md transform active:scale-95 transition-all">SALVAR CONTA</button>
            </div>

            <div class="glass rounded-2xl overflow-hidden border border-slate-700">
                <div class="p-3 bg-slate-800/50 border-b border-slate-700 flex justify-between items-center">
                    <span class="text-xs text-slate-400 uppercase font-bold tracking-wider">√öltimos Lan√ßamentos</span>
                    <span id="expense-total-display" class="text-xs text-red-400 font-bold"></span>
                </div>
                <div id="expenses-list" class="divide-y divide-slate-700/50"></div>
            </div>
        </div>

        <div id="tab-clients" class="tab-content p-4 space-y-4">
            <div id="client-stats-container" class="glass p-3 rounded-xl mb-2 flex flex-col gap-2"></div>
            <div class="flex gap-2">
                <div class="relative flex-1"><i class="fas fa-search absolute left-4 top-3.5 text-slate-500"></i><input type="text" id="search-client" oninput="filterClients()" placeholder="Buscar nome ou celular..." class="w-full bg-slate-800 rounded-xl py-3 pl-11 pr-4 outline-none border border-slate-700 focus:border-blue-500 text-white"></div>
                <button id="btn-filter-inactive" onclick="toggleInactiveFilter()" class="bg-slate-800 w-12 rounded-xl text-slate-400 border border-slate-700 shadow-lg transition-colors" title="Ver Inativos"><i class="fas fa-user-slash"></i></button>
                <button onclick="openModal()" class="bg-blue-600 w-12 rounded-xl text-white shadow-lg"><i class="fas fa-plus"></i></button>
            </div>
            <div id="clients-list" class="space-y-3 pb-20"></div>
        </div>

        <div id="tab-reports" class="tab-content p-4">
            <div class="glass rounded-2xl overflow-hidden border border-slate-700">
                <div class="p-4 border-b border-slate-700 bg-slate-800/50 flex gap-2">
                    <select id="report-filter-month" onchange="renderReportTable()" class="w-1/2 bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded-lg py-2 pl-2 outline-none cursor-pointer"></select>
                    <select id="report-filter-product" onchange="renderReportTable()" class="w-1/2 bg-slate-900 border border-slate-700 text-xs text-slate-300 rounded-lg py-2 pl-2 outline-none cursor-pointer"><option value="all">Planos: Todos</option></select>
                </div>
                <div class="report-container">
                    <table class="report-table w-full">
                        <thead id="report-header"></thead>
                        <tbody id="report-body"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="tab-config" class="tab-content p-4"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-slate-300">Planos</h3><button onclick="openProductModal()" class="bg-emerald-600 text-white text-xs font-bold px-3 py-2 rounded-lg hover:bg-emerald-500"><i class="fas fa-plus mr-1"></i> Novo</button></div><div id="products-list" class="space-y-2 pb-20"></div></div>

        <nav class="fixed bottom-0 left-0 right-0 glass border-t border-slate-700 flex justify-around p-3 z-40 bg-slate-900/90 backdrop-blur-md">
            <button onclick="showTab('tab-home')" id="nav-home" class="nav-item text-blue-500 flex flex-col items-center admin-only" data-tab="tab-home"><i class="fas fa-home text-xl mb-1"></i><span class="text-[10px]">In√≠cio</span></button>
            <button onclick="showTab('tab-expenses')" id="nav-expenses" class="nav-item text-slate-500 flex flex-col items-center admin-only" data-tab="tab-expenses"><i class="fas fa-file-invoice-dollar text-xl mb-1"></i><span class="text-[10px]">Despesas</span></button>
            <button onclick="showTab('tab-reports')" id="nav-reports" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-reports"><i class="fas fa-chart-bar text-xl mb-1"></i><span class="text-[10px]">Relat√≥rios</span></button>
            <button onclick="showTab('tab-clients')" id="nav-clients" class="nav-item text-slate-500 flex flex-col items-center" data-tab="tab-clients"><i class="fas fa-users text-xl mb-1"></i><span class="text-[10px]">Clientes</span></button>
            <button onclick="showTab('tab-config')" id="nav-config" class="nav-item text-slate-500 flex flex-col items-center admin-only" data-tab="tab-config"><i class="fas fa-tags text-xl mb-1"></i><span class="text-[10px]">Planos</span></button>
        </nav>

        <div id="logs-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-slate-900 w-full max-w-md rounded-2xl border border-slate-700 p-6 shadow-2xl h-[80vh] flex flex-col"><div class="flex justify-between items-center mb-4"><h3 class="text-lg font-bold text-white">Auditoria</h3><button onclick="document.getElementById('logs-modal').classList.add('hidden')" class="text-slate-400 hover:text-white"><i class="fas fa-times"></i></button></div><div id="logs-list" class="flex-1 overflow-y-auto space-y-2 pr-2"></div></div></div>

        <div id="client-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-end sm:items-center justify-center p-4 backdrop-blur-sm">
            <div class="bg-slate-900 w-full max-w-md rounded-3xl border border-slate-700 p-6 animate-slide-up max-h-[90vh] overflow-y-auto">
                <h3 id="modal-title" class="text-xl font-bold mb-4">Cliente</h3>
                <input type="hidden" id="modal-client-id">
                <div class="space-y-3">
                    <input type="text" id="modal-name" placeholder="Nome" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white">
                    <div class="flex gap-2">
                        <input type="number" id="modal-due" placeholder="Dia Venc." class="w-1/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white">
                        <input type="text" id="modal-whatsapp" maxlength="17" oninput="maskPhone(this)" onkeyup="maskPhone(this)" placeholder="(DD) 9XXXX-XXXX" class="w-2/3 bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white font-mono tracking-wider">
                    </div>
                    
                    <div id="product-rows-container" class="space-y-2">
                        <div class="flex gap-2 items-center">
                            <input type="number" id="modal-due" placeholder="Dia" class="w-16 bg-slate-800 rounded-lg p-2 text-center text-xs text-white border border-slate-700 font-bold" title="Dia Vencimento">
                            <select id="modal-product" onchange="productChanged(1)" class="flex-1 bg-slate-800 rounded-lg p-2 text-xs text-white border border-slate-700"></select>
                            <input type="text" id="modal-price" onblur="formatInputCurrency(this)" placeholder="R$ 0,00" class="w-20 bg-slate-800 rounded-lg p-2 text-xs text-emerald-400 font-bold border border-slate-700 text-right">
                        </div>
                        <div id="row-prod-2" class="flex gap-2 items-center hidden">
                            <input type="number" id="modal-due-2" placeholder="Dia" class="w-16 bg-slate-800 rounded-lg p-2 text-center text-xs text-white border border-slate-700 font-bold">
                            <select id="modal-product-2" onchange="productChanged(2)" class="flex-1 bg-slate-800 rounded-lg p-2 text-xs text-white border border-slate-700"></select>
                            <input type="text" id="modal-price-2" onblur="formatInputCurrency(this)" placeholder="R$ 0,00" class="w-20 bg-slate-800 rounded-lg p-2 text-xs text-emerald-400 font-bold border border-slate-700 text-right">
                            <button onclick="removeRow(2)" class="text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                        <div id="row-prod-3" class="flex gap-2 items-center hidden">
                            <input type="number" id="modal-due-3" placeholder="Dia" class="w-16 bg-slate-800 rounded-lg p-2 text-center text-xs text-white border border-slate-700 font-bold">
                            <select id="modal-product-3" onchange="productChanged(3)" class="flex-1 bg-slate-800 rounded-lg p-2 text-xs text-white border border-slate-700"></select>
                            <input type="text" id="modal-price-3" onblur="formatInputCurrency(this)" placeholder="R$ 0,00" class="w-20 bg-slate-800 rounded-lg p-2 text-xs text-emerald-400 font-bold border border-slate-700 text-right">
                            <button onclick="removeRow(3)" class="text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                         <div id="row-prod-4" class="flex gap-2 items-center hidden">
                            <input type="number" id="modal-due-4" placeholder="Dia" class="w-16 bg-slate-800 rounded-lg p-2 text-center text-xs text-white border border-slate-700 font-bold">
                            <select id="modal-product-4" onchange="productChanged(4)" class="flex-1 bg-slate-800 rounded-lg p-2 text-xs text-white border border-slate-700"></select>
                            <input type="text" id="modal-price-4" onblur="formatInputCurrency(this)" placeholder="R$ 0,00" class="w-20 bg-slate-800 rounded-lg p-2 text-xs text-emerald-400 font-bold border border-slate-700 text-right">
                            <button onclick="removeRow(4)" class="text-red-400"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                    <button type="button" onclick="addNextRow()" id="btn-add-row" class="text-[10px] text-blue-400 hover:text-white underline w-full text-left">+ Adicionar produto</button>

                    <div class="flex gap-2 mt-2">
                        <select id="modal-status" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none font-bold text-white"><option value="true" class="text-green-400">Ativo</option><option value="false" class="text-red-400">Inativo</option></select>
                    </div>
                </div>
                
                <div class="mt-4 pt-4 border-t border-slate-700"><button id="btn-show-history" onclick="toggleHistorySection()" class="w-full bg-slate-800 text-slate-300 py-2 rounded-lg text-xs font-bold hover:bg-slate-700 border border-slate-700 transition-all flex items-center justify-center gap-2"><i class="fas fa-coins text-yellow-500"></i> Gerenciar Pagamentos</button></div>
                <div id="history-section" class="mt-4 hidden bg-slate-800/50 p-3 rounded-xl border border-slate-700">
                    <div class="flex justify-between items-center mb-2"><h4 class="text-xs font-bold text-slate-400 uppercase">Pagamentos</h4><button onclick="openHistoryForm()" class="text-xs bg-slate-700 px-3 py-1.5 rounded-lg hover:bg-slate-600 border border-slate-600 transition-colors"><i class="fas fa-plus mr-1 text-blue-400"></i> Novo</button></div>
                    <div id="history-form-container" class="bg-slate-800 p-3 rounded-xl border border-blue-500/30 mb-2" style="display:none;"> 
                        <input type="hidden" id="hist-id">
                        <div class="flex gap-2 mb-2"><div class="w-1/2"><label class="text-[9px] text-slate-500 uppercase font-bold">Data</label><input type="date" id="hist-date" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white"></div><div class="w-1/2"><label class="text-[9px] text-slate-500 uppercase font-bold">Valor (R$)</label><input type="text" id="hist-amount" inputmode="decimal" onblur="formatInputCurrency(this)" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white font-bold text-emerald-400"></div></div>
                        <div class="mb-2"><label class="text-[9px] text-slate-500 uppercase font-bold">Referente a qual produto?</label><select id="hist-product" class="w-full bg-slate-900 rounded p-2 text-xs border border-slate-700 text-white"></select></div>
                        <div class="flex gap-2"><button onclick="closeHistoryForm()" class="flex-1 bg-slate-700 text-xs py-2 rounded text-slate-300">Cancelar</button><button onclick="saveHistory()" class="flex-1 bg-blue-600 text-xs py-2 rounded text-white font-bold">Salvar</button></div>
                    </div>
                    <div id="history-list" class="bg-slate-900 rounded-xl p-2 space-y-1 max-h-40 overflow-y-auto text-xs border border-slate-800"></div>
                </div>
                <div class="flex gap-3 mt-6"><button onclick="closeModal()" class="flex-1 py-3 rounded-xl bg-slate-800 text-slate-400">Cancelar</button><button onclick="saveClient()" class="flex-1 py-3 rounded-xl bg-blue-600 text-white font-bold shadow-lg">Salvar Cliente</button></div>
            </div>
        </div>

        <div id="product-modal" class="fixed inset-0 z-50 hidden bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm"><div class="bg-slate-900 w-full max-w-sm rounded-2xl border border-slate-700 p-6 shadow-2xl"><h3 id="product-modal-title" class="text-lg font-bold mb-4">Gerenciar Plano</h3><input type="hidden" id="prod-id"><div class="space-y-3"><div><label class="text-[10px] text-slate-500 uppercase font-bold">Nome do Plano</label><input type="text" id="prod-name" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white"></div><div><label class="text-[10px] text-slate-500 uppercase font-bold">Pre√ßo (R$)</label><input type="number" id="prod-price" step="0.01" class="w-full bg-slate-800 rounded-lg p-3 border border-slate-700 outline-none text-white font-bold text-emerald-400"></div></div><div class="flex gap-3 mt-6"><button onclick="document.getElementById('product-modal').classList.add('hidden')" class="flex-1 py-2.5 rounded-xl bg-slate-800 text-slate-400">Cancelar</button><button onclick="saveProduct()" class="flex-1 py-2.5 rounded-xl bg-emerald-600 text-white font-bold">Salvar</button></div></div></div>
    </div>

    <script>
        const SUPABASE_URL = "https://epwmoicgvuprzkcpxjoy.supabase.co";
        const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVwd21vaWNndnVwcnprY3B4am95Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3NDAxMjgsImV4cCI6MjA4NTMxNjEyOH0.pXcCWqGQSS6YMIZeIyfAaGlNaW6Mx2hfDQtVrX4zues";
        let sb=null,allClients=[],allProducts=[],historyData=[],allExpenses=[],currentMonthGoal=0,showInactiveOnly=false,currentUser="Desconhecido",currentUserConfig=null;
        const USERS_CONFIG = {"1234":{name:"T√∫lio",role:"admin"},"9999":{name:"C√≠cero",role:"admin"},"5555":{name:"Esther",role:"restricted",allowedProduct:"VEO3 - SHARED ESTHER"}};
        const formatCurrency=v=>new Intl.NumberFormat('pt-BR',{style:'currency',currency:'BRL'}).format(v||0);
        const setTxt=(i,v)=>{const e=document.getElementById(i);if(e)e.textContent=v;};
        function formatInputCurrency(e){if(!e.value)return;const v=parseMoneyBR(e.value);if(v!==0&&!isNaN(v))e.value=v.toFixed(2).replace('.',',');}
        function parseMoneyBR(v){if(!v)return 0;if(typeof v==='number')return v;let c=v.replace(/[^\d,-]/g,'');c=c.replace(',','.');return parseFloat(c)||0;}
        function formatPhoneString(v){if(!v)return'';v=v.replace(/\D/g,'');if(v.length>11&&v.startsWith('55'))v=v.substring(2);v=v.substring(0,11);if(v.length>=3&&v[2]!=='9')v=v.substring(0,2)+'9'+v.substring(2);v=v.substring(0,11);if(v.length>10)return v.replace(/^(\d{2})(\d{5})(\d{4}).*/,'($1) $2-$3');if(v.length>6)return v.replace(/^(\d{2})(\d{4})(\d{0,4}).*/,'($1) $2-$3');if(v.length>2)return v.replace(/^(\d{2})(\d{0,5}).*/,'($1) $2');return v;}
        function maskPhone(e){e.value=formatPhoneString(e.value);}
        function getClientProductIds(c){const i=[];if(c.product_id)i.push(c.product_id);if(c.product_id_2)i.push(c.product_id_2);if(c.product_id_3)i.push(c.product_id_3);if(c.product_id_4)i.push(c.product_id_4);return i;}
        function addNextRow(){if(document.getElementById('row-prod-2').classList.contains('hidden'))document.getElementById('row-prod-2').classList.remove('hidden');else if(document.getElementById('row-prod-3').classList.contains('hidden'))document.getElementById('row-prod-3').classList.remove('hidden');else if(document.getElementById('row-prod-4').classList.contains('hidden')){document.getElementById('row-prod-4').classList.remove('hidden');document.getElementById('btn-add-row').classList.add('hidden');}}
        function removeRow(n){document.getElementById(`row-prod-${n}`).classList.add('hidden');document.getElementById(`modal-product-${n}`).value='';document.getElementById(`modal-price-${n}`).value='';document.getElementById(`modal-due-${n}`).value='';document.getElementById('btn-add-row').classList.remove('hidden');}
        function toggleHistorySection(){document.getElementById('history-section').classList.toggle('hidden');}
        function showTab(id){document.querySelectorAll('.tab-content').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.nav-item').forEach(n=>{n.classList.remove('text-blue-500');n.classList.add('text-slate-500');});const t=document.getElementById(id);if(t)t.classList.add('active');const b=document.querySelector(`button[data-tab="${id}"]`);if(b){b.classList.remove('text-slate-500');b.classList.add('text-blue-500');}if(id==='tab-expenses')renderExpensesList();if(id==='tab-home')calculateDashboard();if(id==='tab-clients')filterClients();}
        function performLogin(){try{const b=document.getElementById('btn-login'),p=document.getElementById('pin-input').value;if(b)b.innerText="Verificando...";if(USERS_CONFIG[p]){currentUserConfig=USERS_CONFIG[p];currentUser=currentUserConfig.name;setTxt('header-greeting',`Ol√°, ${currentUser}`);document.getElementById('login-screen').style.display='none';document.getElementById('main-content').classList.remove('hidden');populateMonthFilter();if(currentUserConfig.role==='restricted'){document.querySelectorAll('.admin-only').forEach(el=>el.style.display='none');showTab('tab-clients');}else{document.querySelectorAll('.admin-only').forEach(el=>el.style.display='');showTab('tab-home');}setTimeout(()=>document.getElementById('main-content').style.opacity="1",50);initSystem();}else{alert("PIN Incorreto");if(b)b.innerText="ENTRAR";}}catch(e){console.error(e);}}
        document.addEventListener("DOMContentLoaded",()=>{populateMonthFilter();const b=document.getElementById('btn-login'),i=document.getElementById('pin-input');if(b)b.addEventListener('click',performLogin);if(i)i.addEventListener('keypress',e=>{if(e.key==='Enter')performLogin();});});
        function initSystem(){if(window.supabase){sb=window.supabase.createClient(SUPABASE_URL,SUPABASE_KEY);document.getElementById('connection-status').classList.add('hidden');loadAllData();['payment_history','expenses','clients','products'].forEach(t=>{sb.channel(t).on('postgres_changes',{event:'*',schema:'public',table:t},()=>refreshApp()).subscribe();});}}
        async function refreshApp(){const i=document.getElementById('refresh-icon');if(i)i.classList.add('fa-spin');await loadAllData();if(i)setTimeout(()=>i.classList.remove('fa-spin'),1000);}
        async function loadAllData(){try{await Promise.all([fetchProducts(),fetchClients(),fetchFullHistory(),fetchExpenses()]);document.getElementById('error-alert').classList.add('hidden');populateMonthFilter();calculateDashboard();renderReportTable();updateClientStatsUI();renderExpensesList();}catch(e){console.error(e);}}
        async function fetchProducts(){if(!sb)return;const{data}=await sb.from('products').select('*').order('name');allProducts=data||[];updateProductUI();}
        async function fetchClients(){if(!sb)return;let{data,error}=await sb.from('clients').select('*').order('name');if(error){allClients=[];return;}allClients=data||[];renderClients(allClients);updateClientStatsUI();}
        async function fetchFullHistory(){if(!sb)return;const{data}=await sb.from('payment_history').select('*');historyData=data||[];}
        async function fetchExpenses(){if(!sb)return;const{data}=await sb.from('expenses').select('*').order('date',{ascending:false});allExpenses=data||[];}
        function getAllowedProductId(){if(currentUserConfig.role==='restricted'&&currentUserConfig.allowedProduct){const p=allProducts.find(x=>x.name===currentUserConfig.allowedProduct);return p?p.id:null;}return null;}
        
        // DECLARA√á√ÉO EXPL√çCITA DA FUN√á√ÉO FALTANTE
        function updateClientStatsUI(){
            const el=document.getElementById('client-stats-container');if(!el)return;
            let list=allClients;const ap=getAllowedProductId();if(ap)list=list.filter(c=>getClientProductIds(c).includes(ap));
            const t=list.length,a=list.filter(c=>c.active).length;
            setTxt('stat-total-clients',t);setTxt('stat-active-clients',a);setTxt('stat-inactive-clients',t-a);
            if(currentUserConfig.role==='restricted'){el.innerHTML='';}else{
                const pc={};list.filter(c=>c.active).forEach(c=>{const pids=getClientProductIds(c);if(pids.length===0)pc['Sem Plano']=(pc['Sem Plano']||0)+1;else pids.forEach(p=>{const pr=allProducts.find(x=>x.id===p);const n=pr?pr.name:'Desconhecido';pc[n]=(pc[n]||0)+1;});});
                let h='';Object.keys(pc).sort((a,b)=>pc[b]-pc[a]).forEach(n=>{h+=`<span class="bg-slate-800 px-2 py-1 rounded border border-slate-700 text-[9px] whitespace-nowrap">${n}: <b class="text-white">${pc[n]}</b></span>`;});
                el.innerHTML=`<div class="flex flex-wrap gap-2 justify-center">${h||'<span class="text-slate-500 text-[9px]">Sem dados</span>'}</div>`;
            }
        }

        async function calculateDashboard(){if(currentUserConfig.role==='restricted')return;const el=document.getElementById('dashboard-filter-month');if(!el)return;const v=el.value;let t=new Date();if(v){const[y,m]=v.split('-');t=new Date(parseInt(y),parseInt(m)-1,1);}
            const s=new Date(t.getFullYear(),t.getMonth(),1).toISOString(),e=new Date(t.getFullYear(),t.getMonth()+1,0,23,59,59).toISOString(),mk=v||t.toISOString().slice(0,7);
            const ms=mk; // Fix timezone issue
            try{const{data}=await sb.from('monthly_goals').select('target_amount').eq('month',mk).single();currentMonthGoal=data?Number(data.target_amount):0;}catch(e){currentMonthGoal=0;}
            const gEl=document.getElementById('goal-display');if(gEl){gEl.innerText=`Meta: ${formatCurrency(currentMonthGoal)}`;gEl.classList.remove(currentMonthGoal>0?'hidden':'flex');if(currentMonthGoal===0)gEl.classList.add('hidden');}
            const rec=historyData.filter(h=>{const pm=h.payment_date.substring(0,7);const vs=(h.status==='approved'||!h.status||h.status==='pago');return pm===ms&&vs;}).reduce((a,c)=>a+(Number(c.amount)||0),0);
            const proj=allClients.filter(c=>c.active).reduce((a,c)=>{let v=(c.agreed_price||0)+(c.agreed_price_2||0)+(c.agreed_price_3||0)+(c.agreed_price_4||0);if(v===0)getClientProductIds(c).forEach(p=>{const pr=allProducts.find(x=>x.id===p);if(pr)v+=pr.price;});return a+v;},0);
            const des=allExpenses.filter(e=>e.date.startsWith(ms)),pag=des.filter(e=>e.status==='paid').reduce((a,c)=>a+(Number(c.amount)||0),0);
            setTxt('stat-paid-amount',formatCurrency(rec));setTxt('stat-projected',formatCurrency(proj));setTxt('stat-profit',formatCurrency(rec-pag));
            const prg=document.getElementById('revenue-progress');if(prg){const tg=currentMonthGoal>0?currentMonthGoal:(proj||1);prg.style.width=tg>0?`${Math.min((rec/tg)*100,100)}%`:'0%';}
            let tdm=0;const pl=allClients.filter(c=>{if(!c.active)return false;let ep=(c.agreed_price||0)+(c.agreed_price_2||0)+(c.agreed_price_3||0)+(c.agreed_price_4||0);if(ep===0)return false;const pd=historyData.filter(h=>{const pm=h.payment_date.substring(0,7);return h.client_id===c.id&&pm===ms&&(h.status==='approved'||!h.status||h.status==='pago');}).reduce((a,b)=>a+(Number(b.amount)||0),0);if(pd<ep){tdm+=(ep-pd);return true;}return false;});
            setTxt('stat-pending-total',formatCurrency(tdm));setTxt('pending-header-title',`PEND√äNCIAS (${formatCurrency(tdm)})`);setTxt('badge-count',pl.length);
            const q=document.getElementById('billing-queue');if(q){const tr=document.getElementById('search-pending').value.toLowerCase(),ft=pl.filter(c=>c.name.toLowerCase().includes(tr));if(ft.length===0)q.innerHTML='<div class="p-8 text-center text-slate-500">Tudo em dia!</div>';else q.innerHTML=ft.map(c=>`<div class="p-3 flex justify-between items-center hover:bg-slate-800 transition border-b border-slate-800/50"><div><h4 class="font-bold text-sm text-white">${c.name}</h4><p class="text-[10px] text-slate-400">Vence dia <span class="text-yellow-500">${c.due_day}</span></p></div><div class="flex gap-2"><button onclick="editClient('${c.id}')" class="bg-slate-700 text-blue-400 w-8 h-8 rounded-lg"><i class="fas fa-pen text-xs"></i></button><a href="https://api.whatsapp.com/send?phone=${c.whatsapp}" target="_blank" class="bg-emerald-600 text-white w-8 h-8 rounded-lg flex items-center justify-center"><i class="fab fa-whatsapp"></i></a></div></div>`).join('');}
        }
        function filterPendingQueue(){calculateDashboard();}

        // ... (Restante das fun√ß√µes: openHistoryForm, saveHistory, etc. mantidas iguais) ...
        // Vou compactar as fun√ß√µes auxiliares para caber tudo, mas a l√≥gica est√° 100% igual √† V25.29 + Corre√ß√µes
        function openHistoryForm(pid=null){const f=document.getElementById('history-form-container'),d=document.getElementById('hist-date'),a=document.getElementById('hist-amount'),p=document.getElementById('hist-product'),i=document.getElementById('hist-id');f.style.display='block';p.innerHTML='<option value="">-- Selecione --</option>';allProducts.forEach(x=>{if(currentUserConfig.role==='restricted'&&x.name!==currentUserConfig.allowedProduct)return;const o=document.createElement('option');o.value=x.id;o.text=x.name;p.appendChild(o);});if(pid){const r=historyData.find(x=>x.id===pid);if(r){i.value=r.id;d.value=r.payment_date.slice(0,10);a.value=r.amount.toFixed(2).replace('.',',');p.value=r.product_id||'';}}else{i.value='';d.value=new Date().toISOString().slice(0,10);a.value='';p.value='';}}
        function closeHistoryForm(){document.getElementById('history-form-container').style.display='none';}
        async function saveHistory(){const hid=document.getElementById('hist-id').value,cid=document.getElementById('modal-client-id').value,rv=document.getElementById('hist-amount').value,dt=document.getElementById('hist-date').value,pid=document.getElementById('hist-product').value||null,am=parseMoneyBR(rv);if(!am||!dt)return alert("Inv√°lido");const pl={client_id:cid,amount:am,payment_date:dt+'T12:00:00Z',status:'approved',method:'manual',product_id:pid};if(hid)await sb.from('payment_history').update(pl).eq('id',hid);else await sb.from('payment_history').insert([pl]);logAction(hid?'Edit Pay':'New Pay',`R$ ${am}`);closeHistoryForm();await fetchFullHistory();renderHistoryList(cid);calculateDashboard();}
        function renderHistoryList(cid){const l=document.getElementById('history-list');if(!l)return;l.innerHTML='';const h=historyData.filter(x=>x.client_id===cid).sort((a,b)=>new Date(b.payment_date)-new Date(a.payment_date));if(h.length===0){l.innerHTML='<p class="text-center text-slate-500 py-2">Sem hist√≥rico</p>';return;}l.innerHTML=h.map(i=>{let pl='';if(i.product_id){const p=allProducts.find(x=>x.id===i.product_id);if(p)pl=`<span class="block text-[9px] text-blue-300 font-bold">${p.name}</span>`;}return `<div class="flex justify-between items-center border-b border-slate-700/50 p-2 text-xs bg-slate-800/30 rounded mb-1"><div><span class="text-slate-400 font-mono text-[10px]">${new Date(i.payment_date).toLocaleDateString('pt-BR')}</span>${pl}</div><div class="text-right flex gap-3 items-center"><span class="text-emerald-400 font-bold block">${formatCurrency(i.amount)}</span><button onclick="openHistoryForm('${i.id}')" class="text-blue-400 hover:text-white"><i class="fas fa-pencil-alt"></i></button><button onclick="deleteHistory('${i.id}','${cid}')" class="text-red-400 hover:text-white"><i class="fas fa-trash"></i></button></div></div>`;}).join('');}
        async function deleteHistory(hid,cid){if(confirm("Apagar?")){await sb.from('payment_history').delete().eq('id',hid);await fetchFullHistory();renderHistoryList(cid);calculateDashboard();}}
        async function logAction(a,d){if(!sb)return;try{await sb.from('system_logs').insert({user_name:currentUser,action_type:a,details:d,created_at:new Date().toISOString()});}catch(e){}}
        async function openLogsModal(){const e=document.getElementById('logs-modal'),l=document.getElementById('logs-list');if(e)e.classList.remove('hidden');if(!l)return;l.innerHTML='Loading...';const{data}=await sb.from('system_logs').select('*').order('created_at',{ascending:false}).limit(20);l.innerHTML=data?.map(x=>`<div class="log-entry"><span class="log-user">${x.user_name}</span> ${x.action_type}<br>${x.details}</div>`).join('')||'Vazio';}
        function openModal(){['modal-client-id','modal-name','modal-whatsapp'].forEach(i=>document.getElementById(i).value='');['modal-product','modal-price','modal-due','modal-product-2','modal-price-2','modal-due-2','modal-product-3','modal-price-3','modal-due-3','modal-product-4','modal-price-4','modal-due-4'].forEach(i=>document.getElementById(i).value='');document.getElementById('row-prod-2').classList.add('hidden');document.getElementById('row-prod-3').classList.add('hidden');document.getElementById('row-prod-4').classList.add('hidden');document.getElementById('btn-add-row').classList.remove('hidden');document.getElementById('history-section').classList.add('hidden');if(currentUserConfig.role==='restricted'){const pid=allProducts.find(p=>p.name===currentUserConfig.allowedProduct)?.id;if(pid){document.getElementById('modal-product').value=pid;productChanged(1);document.getElementById('modal-product').disabled=true;document.getElementById('btn-add-row').style.display='none';}}else{document.getElementById('modal-product').disabled=false;document.getElementById('btn-add-row').style.display='';}document.getElementById('client-modal').classList.remove('hidden');}
        function closeModal(){document.getElementById('client-modal').classList.add('hidden');}
        async function editClient(id){const c=allClients.find(x=>x.id===id);if(!c)return;document.getElementById('modal-client-id').value=c.id;document.getElementById('modal-name').value=c.name;const wp=document.getElementById('modal-whatsapp');wp.value=c.whatsapp||'';maskPhone(wp);document.getElementById('modal-status').value=c.active;
            const fill=(n,d,p,pr)=>{document.getElementById(`modal-due${n>1?'-'+n:''}`).value=d||'';document.getElementById(`modal-product${n>1?'-'+n:''}`).value=p||'';document.getElementById(`modal-price${n>1?'-'+n:''}`).value=pr?pr.toFixed(2).replace('.',','):'';if(n>1&&(d||p||pr))document.getElementById(`row-prod-${n}`).classList.remove('hidden');else if(n>1)document.getElementById(`row-prod-${n}`).classList.add('hidden');};
            fill(1,c.due_day,c.product_id,c.agreed_price);fill(2,c.due_day_2,c.product_id_2,c.agreed_price_2);fill(3,c.due_day_3,c.product_id_3,c.agreed_price_3);fill(4,c.due_day_4,c.product_id_4,c.agreed_price_4);
            if(currentUserConfig.role==='restricted'){document.getElementById('modal-product').disabled=true;document.getElementById('btn-add-row').style.display='none';}else{document.getElementById('modal-product').disabled=false;document.getElementById('btn-add-row').style.display='';}
            document.getElementById('history-section').classList.add('hidden');renderHistoryList(id);document.getElementById('client-modal').classList.remove('hidden');}
        async function saveClient(){
            const id=document.getElementById('modal-client-id').value,nm=document.getElementById('modal-name').value,wp=document.getElementById('modal-whatsapp').value,ac=document.getElementById('modal-status').value==='true';
            let p1,p2,p3,p4;
            if(currentUserConfig.role==='restricted'){const ap=getAllowedProductId(),pd=allProducts.find(p=>p.id===ap),du=parseInt(document.getElementById('modal-due').value)||10;p1={pid:ap,price:pd?pd.price:0,due:du};p2={pid:null};p3={pid:null};p4={pid:null};}else{
                const g=(n)=>{if(n>1&&document.getElementById(`row-prod-${n}`).classList.contains('hidden'))return{d:null,p:null,pr:null};return{d:parseInt(document.getElementById(`modal-due${n>1?'-'+n:''}`).value)||null,p:document.getElementById(`modal-product${n>1?'-'+n:''}`).value||null,pr:parseMoneyBR(document.getElementById(`modal-price${n>1?'-'+n:''}`).value)};}
                p1=g(1);p2=g(2);p3=g(3);p4=g(4);
            }
            const d={name:nm,whatsapp:wp,active:ac,due_day:p1.d,product_id:p1.p,agreed_price:p1.pr,due_day_2:p2.d,product_id_2:p2.p,agreed_price_2:p2.pr,due_day_3:p3.d,product_id_3:p3.p,agreed_price_3:p3.pr,due_day_4:p4.d,product_id_4:p4.p,agreed_price_4:p4.pr};
            let nid=id; if(id)await sb.from('clients').update(d).eq('id',id);else{const{data}=await sb.from('clients').insert([d]).select();if(data&&data[0]){nid=data[0].id;if(nid){const dt=new Date().toISOString().slice(0,10)+'T12:00:00Z',py=[];if(p1.p&&p1.pr)py.push({client_id:nid,product_id:p1.p,amount:p1.pr,payment_date:dt,status:'approved',method:'auto_reg'});if(p2.p&&p2.pr)py.push({client_id:nid,product_id:p2.p,amount:p2.pr,payment_date:dt,status:'approved',method:'auto_reg'});if(p3.p&&p3.pr)py.push({client_id:nid,product_id:p3.p,amount:p3.pr,payment_date:dt,status:'approved',method:'auto_reg'});if(p4.p&&p4.pr)py.push({client_id:nid,product_id:p4.p,amount:p4.pr,payment_date:dt,status:'approved',method:'auto_reg'});if(py.length>0)await sb.from('payment_history').insert(py);}}}
            closeModal();loadAllData();
        }
        async function deleteClient(id,n){if(confirm(`Excluir ${n}?`)){await sb.from('payment_history').delete().eq('client_id',id);await sb.from('clients').delete().eq('id',id);loadAllData();}}
        function renderClients(l){
            const el=document.getElementById('clients-list'),tm=document.getElementById('search-client').value.toLowerCase(),tc=tm.replace(/\D/g,'');
            let ls=l;if(currentUserConfig.role==='restricted'){const ap=getAllowedProductId();if(ap)ls=ls.filter(c=>getClientProductIds(c).includes(ap));else ls=[];}
            const fl=ls.filter(c=>{const nm=c.name.toLowerCase().includes(tm),ph=(c.whatsapp||'').replace(/\D/g,'').includes(tc&&tc.length>2?tc:'XYZ');if(!nm&&!ph)return false;if(showInactiveOnly&&c.active)return false;if(!showInactiveOnly&&!c.active)return false;return true;});
            if(fl.length===0)el.innerHTML='<p class="text-center text-slate-500 text-xs mt-4">Nada encontrado.</p>';else el.innerHTML=fl.map(c=>{
                const r=[];const ad=(d,p,pr)=>{if(p){const pn=allProducts.find(x=>x.id===p)?.name||'Antigo';r.push(`Dia ${d||'?'} - ${pn} - ${formatCurrency(pr)}`);}};
                ad(c.due_day,c.product_id,c.agreed_price);ad(c.due_day_2,c.product_id_2,c.agreed_price_2);ad(c.due_day_3,c.product_id_3,c.agreed_price_3);ad(c.due_day_4,c.product_id_4,c.agreed_price_4);
                return `<div class="glass p-4 rounded-xl flex justify-between items-center border-l-4 ${c.active?'border-l-emerald-500':'border-l-red-500'}"><div onclick="editClient('${c.id}')" class="flex-1 cursor-pointer"><h4 class="font-bold text-sm text-white tracking-wide">${c.name}</h4><div class="text-[10px] text-slate-400 mt-1">${r.join('<br>')}<br><span class="text-slate-500">${formatPhoneString(c.whatsapp)}</span></div></div><div class="flex gap-2"><button onclick="deleteClient('${c.id}','${c.name}')" class="w-8 h-8 rounded flex items-center justify-center text-slate-500 hover:text-red-400"><i class="fas fa-trash text-xs"></i></button><button onclick="editClient('${c.id}')" class="bg-slate-800 w-8 h-8 rounded flex items-center justify-center text-blue-400"><i class="fas fa-pen text-xs"></i></button></div></div>`;
            }).join('');
        }
        function filterClients(){renderClients(allClients);}
        function renderExpensesList(){const l=document.getElementById('expenses-list');if(!l)return;const s=allExpenses.slice(0,50);if(s.length===0)l.innerHTML='<p class="text-center text-xs text-slate-500 p-4">Sem despesas.</p>';else l.innerHTML=s.map(e=>`<div class="flex justify-between items-center p-3 hover:bg-slate-800/30 transition-all ${e.status==='paid'?'opacity-60':''}"><div class="flex items-center gap-3 cursor-pointer" onclick="toggleExpenseStatus('${e.id}','${e.status}')"><div class="text-lg">${e.status==='paid'?'‚úÖ':'üïí'}</div><div><span class="text-white text-xs font-bold block ${e.status==='paid'?'line-through':''}">${e.description}</span><span class="text-slate-500 text-[9px]">${new Date(e.date).toLocaleDateString('pt-BR')}</span></div></div><div class="flex items-center gap-3"><span class="text-xs font-bold ${e.status==='paid'?'text-slate-500':'text-red-400'}">-${formatCurrency(e.amount)}</span><button onclick="deleteExpense('${e.id}')" class="text-slate-600 hover:text-red-500"><i class="fas fa-trash text-xs"></i></button></div></div>`).join('');}
        async function saveExpense(){const d=document.getElementById('exp-desc').value,v=document.getElementById('exp-amount').value,dt=document.getElementById('exp-date').value,s=document.getElementById('exp-status').value,a=parseMoneyBR(v);if(!d||!a)return alert('Erro');await sb.from('expenses').insert([{description:d,amount:a,date:dt,status:s}]);document.getElementById('exp-desc').value='';document.getElementById('exp-amount').value='';loadAllData();}
        async function toggleExpenseStatus(id,s){await sb.from('expenses').update({status:s==='paid'?'pending':'paid'}).eq('id',id);loadAllData();}
        async function deleteExpense(id){if(confirm('Apagar?')){await sb.from('expenses').delete().eq('id',id);loadAllData();}}
        function renderReportTable(){
            const m=document.getElementById('report-filter-month');if(!m)return;const v=m.value;if(!v)return;const ms=v,pid=document.getElementById('report-filter-product').value;
            let l=allClients;if(currentUserConfig.role==='restricted'){const ap=getAllowedProductId();if(ap)l=l.filter(c=>historyData.some(h=>h.client_id===c.id&&h.product_id===ap));else l=[];}
            l=l.filter(c=>{if(!c.active)return false;if(pid!=='all'){if(!historyData.some(h=>h.client_id===c.id&&h.product_id===pid&&h.payment_date.startsWith(ms)))return false;}return true;});
            l.sort((a,b)=>a.name.localeCompare(b.name));
            const tot=l.reduce((a,c)=>{const p=historyData.filter(h=>h.client_id===c.id&&h.payment_date.startsWith(ms)&&(h.status==='approved'||!h.status||h.status==='pago')).reduce((x,y)=>x+(Number(y.amount)||0),0);return a+p;},0);
            const pts=v.split('-'),mn=new Date(pts[0],pts[1]-1,1).toLocaleDateString('pt-BR',{month:'short'}).toUpperCase().replace('.','');
            document.getElementById('report-header').innerHTML=`<tr><th class="sticky-col text-left text-white bg-slate-900 border-r border-slate-700">CLIENTES (${l.length})</th><th colspan="2" class="text-emerald-400 bg-slate-900 border-l border-slate-700 font-bold tracking-widest text-[10px] text-center">${mn} | ${formatCurrency(tot)}</th></tr><tr><th class="sticky-col bg-slate-900 border-r border-slate-700"></th><th class="sub-header text-blue-300 border-l border-slate-700 text-[9px] uppercase">DATA PAGTO</th><th class="sub-header text-emerald-300 border-l border-slate-800 text-[9px] uppercase">VALOR PAGO</th></tr>`;
            document.getElementById('report-body').innerHTML=l.length===0?'<tr><td colspan="3" class="text-center p-4 text-xs text-slate-500">Nada encontrado.</td></tr>':l.map(c=>{
                const pays=historyData.filter(h=>h.client_id===c.id&&h.payment_date.startsWith(ms)&&(h.status==='approved'||!h.status||h.status==='pago'));
                const tp=pays.reduce((a,b)=>a+(Number(b.amount)||0),0);let dp='-';if(pays.length>0)dp=new Date(pays[pays.length-1].payment_date).getUTCDate();
                const ddl=`<span class="bg-slate-700 px-1 rounded mr-1 text-[9px] text-slate-300">${c.due_day||'?'}</span>`;
                return `<tr><td class="sticky-col text-xs text-left p-2 border-b border-slate-800 text-white truncate max-w-[160px]" onclick="editClient('${c.id}')">${ddl} ${c.name}</td><td class="text-center text-xs p-2 border-b border-slate-800 text-slate-500 font-mono">${dp}</td><td class="text-center p-2 border-b border-slate-800 ${tp>0?'text-emerald-400 font-bold bg-emerald-500/10 text-[9px]':'text-slate-600 text-[9px]'}">${tp>0?formatCurrency(tp):'-'}</td></tr>`;
            }).join('');
        }
        function updateProductUI(){const o='<option value="">Sem Plano</option>'+allProducts.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');['modal-product','modal-product-2','modal-product-3','modal-product-4'].forEach(i=>{const e=document.getElementById(i);if(e)e.innerHTML=o;});document.getElementById('report-filter-product').innerHTML='<option value="all">Planos: Todos</option>'+allProducts.map(p=>`<option value="${p.id}">${p.name}</option>`).join('');}
        function productChanged(s){const pv=document.getElementById(s===1?'modal-product':`modal-product-${s}`).value,pe=document.getElementById(s===1?'modal-price':`modal-price-${s}`),p=allProducts.find(x=>x.id===pv);if(p)pe.value=p.price.toFixed(2).replace('.',',');else pe.value='';}
        function toggleNotifPanel(){const p=document.getElementById('notif-panel');p.style.display=p.style.display==='flex'?'none':'flex';}
        function populateMonthFilter(){const e=document.getElementById('dashboard-filter-month'),r=document.getElementById('report-filter-month');if(e.options.length>0)return;let h='';for(let i=-6;i<=6;i++){const d=new Date();d.setMonth(d.getMonth()+i);const v=d.toISOString().slice(0,7),l=d.toLocaleDateString('pt-BR',{month:'long',year:'numeric'});h+=`<option value="${v}" ${i===0?'selected':''}>${l}</option>`;}e.innerHTML=h;r.innerHTML=h;}
        function toggleInactiveFilter(){showInactiveOnly=!showInactiveOnly;renderClients(allClients);}
        async function setMonthlyGoal(){const m=document.getElementById('dashboard-filter-month').value,v=prompt("Nova meta",currentMonthGoal);if(v)await sb.from('monthly_goals').upsert({month:m,target_amount:parseMoneyBR(v)});calculateDashboard();}
    </script>
</body>
</html>
